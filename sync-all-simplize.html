<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>üöÄ Sync ALL Simplize Data</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #0f172a; color: #e2e8f0; margin: 0; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #38bdf8; margin-bottom: 10px; }
        .subtitle { color: #94a3b8; margin-bottom: 20px; }
        .card { background: #1e293b; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .btn { padding: 14px 28px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-right: 10px; margin-bottom: 10px; font-size: 14px; }
        .btn-primary { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; }
        .btn-success { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .progress { background: #334155; border-radius: 8px; height: 30px; overflow: hidden; margin: 15px 0; }
        .progress-bar { background: linear-gradient(90deg, #6366f1, #22c55e); height: 100%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: bold; }
        .log { background: #0f172a; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 12px; }
        .log-item { padding: 3px 0; border-bottom: 1px solid #1e293b; }
        .log-success { color: #22c55e; }
        .log-error { color: #ef4444; }
        .log-info { color: #3b82f6; }
        .log-warning { color: #f59e0b; }
        .stats { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat { background: linear-gradient(135deg, #1e293b, #334155); padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #475569; }
        .stat-value { font-size: 28px; font-weight: bold; color: #22c55e; }
        .stat-label { font-size: 11px; color: #94a3b8; margin-top: 5px; text-transform: uppercase; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th, td { padding: 8px 6px; text-align: left; border-bottom: 1px solid #334155; }
        th { background: #334155; color: #94a3b8; position: sticky; top: 0; }
        .price-up { color: #22c55e; }
        .price-down { color: #ef4444; }
        .price-ref { color: #f59e0b; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 1200px) { .stats { grid-template-columns: repeat(3, 1fr); } .grid-2 { grid-template-columns: 1fr; } }
        .status-running { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .badge-success { background: #22c55e20; color: #22c55e; }
        .badge-error { background: #ef444420; color: #ef4444; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Sync ALL Simplize Data to Database</h1>
        <p class="subtitle">ƒê·ªìng b·ªô gi√° realtime, ch·ªâ s·ªë t√†i ch√≠nh, v√† ph√¢n t√≠ch k·ªπ thu·∫≠t t·ª´ Simplize API</p>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="totalStocks">0</div>
                <div class="stat-label">T·ªïng m√£</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="syncedCount">0</div>
                <div class="stat-label">ƒê√£ sync</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="priceCount">0</div>
                <div class="stat-label">Gi√° realtime</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="ratioCount">0</div>
                <div class="stat-label">Ch·ªâ s·ªë TC</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="errorCount">0</div>
                <div class="stat-label">L·ªói</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="syncTime">0s</div>
                <div class="stat-label">Th·ªùi gian</div>
            </div>
        </div>

        <div class="card">
            <h3>‚ö° Ch·ªçn lo·∫°i ƒë·ªìng b·ªô</h3>
            <button class="btn btn-primary" onclick="syncVN30()" id="btnVN30">üîµ Sync VN30 (30 m√£)</button>
            <button class="btn btn-success" onclick="syncVN100()" id="btnVN100">üü¢ Sync VN100 (100 m√£)</button>
            <button class="btn btn-warning" onclick="syncAll()" id="btnAll">üü° Sync ALL (200+ m√£)</button>
            <button class="btn btn-danger" onclick="stopSync()" id="btnStop" disabled>‚èπÔ∏è D·ª´ng</button>
            
            <div class="progress" id="progressContainer">
                <div class="progress-bar" id="progressBar" style="width: 0%">S·∫µn s√†ng...</div>
            </div>
        </div>

        <div class="grid-2">
            <div class="card">
                <h3>üìä K·∫øt qu·∫£ Sync (m·ªõi nh·∫•t)</h3>
                <div style="max-height: 350px; overflow-y: auto;">
                    <table id="resultsTable">
                        <thead>
                            <tr>
                                <th>M√£</th>
                                <th>Gi√°</th>
                                <th>+/-</th>
                                <th>%</th>
                                <th>KL</th>
                                <th>PE</th>
                                <th>PB</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>üìù Log chi ti·∫øt</h3>
                <div class="log" id="logContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // Supabase config
        const SUPABASE_URL = "https://trbiojajipzpqlnlghtt.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRyYmlvamFqaXB6cHFsbmxnaHR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMTg1NDEsImV4cCI6MjA4MTc5NDU0MX0.TOtVLQeFjes6NbnBTF6z-YPbFhSA-olvjJnAl60qhKQ";

        // Stock lists
        const VN30 = ['ACB', 'BCM', 'BID', 'BVH', 'CTG', 'FPT', 'GAS', 'GVR', 'HDB', 'HPG', 
                      'MBB', 'MSN', 'MWG', 'PLX', 'POW', 'SAB', 'SHB', 'SSB', 'SSI', 'STB', 
                      'TCB', 'TPB', 'VCB', 'VHM', 'VIB', 'VIC', 'VJC', 'VNM', 'VPB', 'VRE'];

        const VN100_EXTRA = ['AAA', 'ANV', 'ASM', 'BWE', 'CII', 'CMG', 'DBC', 'DCM', 'DGC', 'DGW',
                       'DIG', 'DPM', 'DXG', 'EIB', 'EVF', 'FRT', 'GMD', 'HAG', 'HCM', 'HDC',
                       'HDG', 'HNG', 'HSG', 'HT1', 'IMP', 'KBC', 'KDC', 'KDH', 'LPB', 'MSB',
                       'NLG', 'NT2', 'NVL', 'OCB', 'PAN', 'PC1', 'PDR', 'PHR', 'PNJ', 'PPC',
                       'PVD', 'PVS', 'PVT', 'REE', 'SBT', 'SCR', 'SCS', 'SJS', 'SSC', 'TCH',
                       'TLG', 'VCI', 'VGC', 'VHC', 'VND', 'VOS', 'VPI', 'VTP'];

        const ALL_EXTRA = ['AGG', 'AGR', 'APH', 'BAF', 'BFC', 'BMP', 'BSI', 'BVS', 'C4G', 'CAV',
                          'CCL', 'CEO', 'CKG', 'CLW', 'CNG', 'CSV', 'CTD', 'CTI', 'CTR', 'D2D',
                          'DAH', 'DBC', 'DBD', 'DCL', 'DHA', 'DHC', 'DLG', 'DMC', 'DPG', 'DRC',
                          'DSN', 'DXS', 'FCN', 'FIT', 'FMC', 'FTS', 'GEX', 'GIL', 'HAH', 'HAP',
                          'HBC', 'HHS', 'HID', 'HII', 'HMC', 'HQC', 'HRC', 'HTN', 'HTV', 'HVN',
                          'IDI', 'IJC', 'ITA', 'ITD', 'JVC', 'KHG', 'KOS', 'KPF', 'KSB', 'L10',
                          'LCG', 'LDG', 'LHG', 'LIX', 'LSS', 'MBS', 'MCG', 'MIG', 'NAB', 'NAF',
                          'NBB', 'NCT', 'NHA', 'NKG', 'NNC', 'NSC', 'NT2', 'NTL', 'OGC', 'ORS',
                          'PAC', 'PET', 'PGC', 'PGD', 'PGI', 'PGV', 'PIT', 'PLP', 'PMG', 'POM',
                          'POW', 'PSH', 'PTB', 'PTC', 'PVB', 'PVC', 'PVP', 'QBS', 'RAL', 'RDP'];

        const VN100 = [...VN30, ...VN100_EXTRA];
        const ALL_STOCKS = [...new Set([...VN100, ...ALL_EXTRA])];

        let syncedCount = 0;
        let priceCount = 0;
        let ratioCount = 0;
        let errorCount = 0;
        let startTime = 0;
        let isRunning = false;
        let shouldStop = false;

        function log(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const item = document.createElement('div');
            item.className = `log-item log-${type}`;
            item.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.insertBefore(item, container.firstChild);
            if (container.children.length > 200) container.removeChild(container.lastChild);
        }

        function updateStats(current, total) {
            const percent = Math.round((current / total) * 100);
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressBar').textContent = `${percent}% (${current}/${total})`;
            document.getElementById('syncedCount').textContent = syncedCount;
            document.getElementById('priceCount').textContent = priceCount;
            document.getElementById('ratioCount').textContent = ratioCount;
            document.getElementById('errorCount').textContent = errorCount;
            document.getElementById('syncTime').textContent = `${((Date.now() - startTime) / 1000).toFixed(1)}s`;
        }

        async function fetchSimplizeSnapshot(symbol) {
            const response = await fetch(`https://api.simplize.vn/api/company/snapshot/${symbol}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return (await response.json()).data;
        }

        async function fetchSimplizeFinancials(symbol) {
            try {
                const response = await fetch(`https://api.simplize.vn/api/company/financial-ratio/${symbol}?type=yearly`);
                if (!response.ok) return null;
                return (await response.json()).data;
            } catch { return null; }
        }

        async function fetchSimplizeTechnical(symbol) {
            try {
                const response = await fetch(`https://api.simplize.vn/api/company/technical-analysis/${symbol}`);
                if (!response.ok) return null;
                return (await response.json()).data;
            } catch { return null; }
        }

        async function upsertToSupabase(table, data) {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'resolution=merge-duplicates'
                },
                body: JSON.stringify(data)
            });
            if (!response.ok) throw new Error(await response.text());
            return true;
        }

        function addResultRow(symbol, data, status, isError = false) {
            const tbody = document.getElementById('resultsBody');
            const row = document.createElement('tr');
            
            if (data && !isError) {
                const price = data.price_close || 0;
                const change = data.net_change || 0;
                const pct = data.pct_change || 0;
                const volume = data.volume || 0;
                const colorClass = change > 0 ? 'price-up' : change < 0 ? 'price-down' : 'price-ref';
                
                row.innerHTML = `
                    <td><strong>${symbol}</strong></td>
                    <td>${price.toLocaleString()}</td>
                    <td class="${colorClass}">${change >= 0 ? '+' : ''}${change.toLocaleString()}</td>
                    <td class="${colorClass}">${pct >= 0 ? '+' : ''}${pct.toFixed(2)}%</td>
                    <td>${(volume / 1000000).toFixed(1)}M</td>
                    <td>${data.pe_ratio?.toFixed(1) || '-'}</td>
                    <td>${data.pb_ratio?.toFixed(2) || '-'}</td>
                    <td><span class="badge badge-success">‚úì</span></td>
                `;
            } else {
                row.innerHTML = `
                    <td><strong>${symbol}</strong></td>
                    <td colspan="6" style="color:#94a3b8">-</td>
                    <td><span class="badge badge-error">‚úó</span></td>
                `;
            }
            
            tbody.insertBefore(row, tbody.firstChild);
            if (tbody.children.length > 100) tbody.removeChild(tbody.lastChild);
        }

        async function syncStock(symbol) {
            if (shouldStop) return false;
            
            try {
                // Fetch all data in parallel
                const [snapshot, financials, technical] = await Promise.all([
                    fetchSimplizeSnapshot(symbol),
                    fetchSimplizeFinancials(symbol),
                    fetchSimplizeTechnical(symbol)
                ]);

                if (!snapshot) {
                    errorCount++;
                    addResultRow(symbol, null, 'No data', true);
                    return false;
                }

                // Build comprehensive stock data
                const stockData = {
                    symbol: symbol.toUpperCase(),
                    name_vi: snapshot.companyName || snapshot.name || symbol,
                    stock_exchange: snapshot.exchange || 'HOSE',
                    price_close: snapshot.priceClose || snapshot.price || 0,
                    price_open: snapshot.priceOpen || snapshot.open || 0,
                    price_high: snapshot.priceHigh || snapshot.high || 0,
                    price_low: snapshot.priceLow || snapshot.low || 0,
                    net_change: snapshot.netChange || snapshot.change || 0,
                    pct_change: snapshot.pctChange || 0,
                    volume: snapshot.volume || 0,
                    value: snapshot.value || 0,
                    price_ceiling: snapshot.priceCeiling || 0,
                    price_floor: snapshot.priceFloor || 0,
                    price_reference: snapshot.priceReference || 0,
                    market_cap: snapshot.marketCap || 0,
                    pe_ratio: snapshot.pe || 0,
                    pb_ratio: snapshot.pb || 0,
                    ps_ratio: snapshot.ps || 0,
                    eps: snapshot.eps || 0,
                    bvps: snapshot.bvps || 0,
                    roe: snapshot.roe || 0,
                    roa: snapshot.roa || 0,
                    ros: snapshot.ros || 0,
                    dividend_yield: snapshot.dividendYield || 0,
                    beta_5y: snapshot.beta || 0,
                    shares_outstanding: snapshot.sharesOutstanding || 0,
                    free_float: snapshot.freeFloat || 0,
                    foreign_ownership: snapshot.foreignOwnership || 0,
                    // Technical signals
                    ta_signal_1d: technical?.signal1D || null,
                    ta_signal_1w: technical?.signal1W || null,
                    ta_signal_1m: technical?.signal1M || null,
                    rsi_14: technical?.rsi14 || null,
                    macd_signal: technical?.macdSignal || null,
                    ma_20: technical?.ma20 || null,
                    ma_50: technical?.ma50 || null,
                    ma_200: technical?.ma200 || null,
                    // Risk metrics
                    overall_risk_level: snapshot.riskLevel || null,
                    volatility_30d: snapshot.volatility30d || null,
                    updated_at: new Date().toISOString()
                };

                // Upsert to database
                await upsertToSupabase('simplize_company_data', stockData);
                
                syncedCount++;
                priceCount++;
                if (financials || technical) ratioCount++;
                
                addResultRow(symbol, stockData, 'OK');
                log(`‚úÖ ${symbol}: ${stockData.price_close.toLocaleString()} (${stockData.pct_change >= 0 ? '+' : ''}${stockData.pct_change.toFixed(2)}%)`, 'success');
                
                return true;
            } catch (error) {
                errorCount++;
                addResultRow(symbol, null, error.message, true);
                log(`‚ùå ${symbol}: ${error.message}`, 'error');
                return false;
            }
        }

        async function syncSymbols(symbols, label) {
            if (isRunning) {
                log('‚ö†Ô∏è ƒêang ch·∫°y sync kh√°c, vui l√≤ng ƒë·ª£i...', 'warning');
                return;
            }

            isRunning = true;
            shouldStop = false;
            document.getElementById('btnStop').disabled = false;
            document.getElementById('btnVN30').disabled = true;
            document.getElementById('btnVN100').disabled = true;
            document.getElementById('btnAll').disabled = true;

            document.getElementById('totalStocks').textContent = symbols.length;
            document.getElementById('resultsBody').innerHTML = '';
            syncedCount = 0;
            priceCount = 0;
            ratioCount = 0;
            errorCount = 0;
            startTime = Date.now();

            log(`üöÄ B·∫Øt ƒë·∫ßu sync ${label} (${symbols.length} m√£)...`, 'info');

            const batchSize = 5;
            for (let i = 0; i < symbols.length && !shouldStop; i += batchSize) {
                const batch = symbols.slice(i, i + batchSize);
                await Promise.all(batch.map(symbol => syncStock(symbol)));
                updateStats(Math.min(i + batchSize, symbols.length), symbols.length);
                
                if (i + batchSize < symbols.length && !shouldStop) {
                    await new Promise(r => setTimeout(r, 300));
                }
            }

            const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);
            const status = shouldStop ? '‚èπÔ∏è ƒê√£ d·ª´ng' : '‚úÖ Ho√†n th√†nh';
            log(`${status}! Sync ${syncedCount}/${symbols.length} m√£ trong ${totalTime}s`, shouldStop ? 'warning' : 'success');

            isRunning = false;
            shouldStop = false;
            document.getElementById('btnStop').disabled = true;
            document.getElementById('btnVN30').disabled = false;
            document.getElementById('btnVN100').disabled = false;
            document.getElementById('btnAll').disabled = false;
        }

        function syncVN30() { syncSymbols(VN30, 'VN30'); }
        function syncVN100() { syncSymbols(VN100, 'VN100'); }
        function syncAll() { syncSymbols(ALL_STOCKS, 'ALL STOCKS'); }
        function stopSync() { shouldStop = true; log('‚èπÔ∏è ƒêang d·ª´ng...', 'warning'); }

        log('üîß S·∫µn s√†ng sync d·ªØ li·ªáu Simplize. Ch·ªçn lo·∫°i sync ƒë·ªÉ b·∫Øt ƒë·∫ßu.', 'info');
    </script>
</body>
</html>

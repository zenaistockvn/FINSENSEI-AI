<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sync Stock News - FinSensei AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-900 text-white min-h-screen p-8">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-2">üì∞ Sync Stock News</h1>
    <p class="text-slate-400 mb-8">T·∫°o b·∫£ng v√† ƒë·ªìng b·ªô tin t·ª©c l√™n Supabase</p>

    <div class="bg-slate-800 rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Step 1: T·∫°o b·∫£ng stock_news (SQL)</h2>
      <p class="text-slate-400 text-sm mb-4">Copy SQL n√†y v√†o Supabase Dashboard > SQL Editor:</p>
      <pre class="bg-slate-900 p-4 rounded-lg text-xs overflow-x-auto mb-4 text-emerald-400">CREATE TABLE IF NOT EXISTS stock_news (
  id SERIAL PRIMARY KEY,
  symbol VARCHAR(20),
  title VARCHAR(500) NOT NULL,
  summary TEXT,
  source VARCHAR(100),
  url VARCHAR(500),
  published_at TIMESTAMPTZ DEFAULT NOW(),
  sentiment VARCHAR(20) DEFAULT 'neutral',
  ai_summary TEXT,
  category VARCHAR(50) DEFAULT 'general',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(title, source)
);

CREATE INDEX IF NOT EXISTS idx_stock_news_symbol ON stock_news(symbol);
CREATE INDEX IF NOT EXISTS idx_stock_news_published ON stock_news(published_at DESC);
ALTER TABLE stock_news ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow public read" ON stock_news FOR SELECT USING (true);
CREATE POLICY "Allow service insert" ON stock_news FOR INSERT WITH CHECK (true);</pre>
      <button onclick="checkTable()" class="bg-indigo-600 hover:bg-indigo-700 px-6 py-3 rounded-lg font-bold mb-4">
        Ki·ªÉm tra b·∫£ng ƒë√£ t·∫°o ch∆∞a
      </button>
      <div id="createResult" class="text-sm"></div>
    </div>

    <div class="bg-slate-800 rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Step 2: Sync tin t·ª©c</h2>
      <button onclick="syncNews()" class="bg-emerald-600 hover:bg-emerald-700 px-6 py-3 rounded-lg font-bold mb-4">
        Sync Tin T·ª©c
      </button>
      <div id="syncResult" class="text-sm"></div>
    </div>

    <div class="bg-slate-800 rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Step 3: Ki·ªÉm tra</h2>
      <button onclick="checkNews()" class="bg-amber-600 hover:bg-amber-700 px-6 py-3 rounded-lg font-bold mb-4">
        Ki·ªÉm tra
      </button>
      <div id="checkResult" class="text-sm"></div>
    </div>

    <div class="bg-slate-800 rounded-xl p-6">
      <h2 class="text-lg font-bold mb-4">Log</h2>
      <div id="log" class="bg-slate-900 rounded-lg p-4 h-48 overflow-y-auto font-mono text-xs"></div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://trbiojajipzpqlnlghtt.supabase.co";
    const SERVICE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRyYmlvamFqaXB6cHFsbmxnaHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjIxODU0MSwiZXhwIjoyMDgxNzk0NTQxfQ.auj1AHSwWifdueryQXXgUHo6hK0uqkJxt_Gizfb6UfU";

    function log(msg, type = 'info') {
      const logEl = document.getElementById('log');
      const colors = { info: 'text-slate-300', success: 'text-emerald-400', error: 'text-rose-400' };
      logEl.innerHTML += `<div class="${colors[type]}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    async function checkTable() {
      const resultEl = document.getElementById('createResult');
      resultEl.innerHTML = '<span class="text-amber-400">Checking...</span>';
      
      const checkResponse = await fetch(`${SUPABASE_URL}/rest/v1/stock_news?limit=1`, {
        headers: { 'apikey': SERVICE_KEY, 'Authorization': `Bearer ${SERVICE_KEY}` }
      });
      
      if (checkResponse.ok) {
        resultEl.innerHTML = '<span class="text-emerald-400">‚úÖ B·∫£ng ƒë√£ t·ªìn t·∫°i! C√≥ th·ªÉ sync tin t·ª©c.</span>';
        log('Table exists!', 'success');
      } else {
        resultEl.innerHTML = '<span class="text-rose-400">‚ùå B·∫£ng ch∆∞a t·ªìn t·∫°i. Vui l√≤ng copy SQL ·ªü tr√™n v√† ch·∫°y trong Supabase Dashboard.</span>';
        log('Table not found. Please create it first.', 'error');
      }
    }

    const NEWS = [
      { symbol: null, title: "VN-Index v∆∞·ª£t m·ªëc 1,280 ƒëi·ªÉm, thanh kho·∫£n tƒÉng m·∫°nh", summary: "Th·ªã tr∆∞·ªùng ch·ª©ng kho√°n Vi·ªát Nam ti·∫øp t·ª•c ƒë√† tƒÉng v·ªõi thanh kho·∫£n c·∫£i thi·ªán ƒë√°ng k·ªÉ.", source: "CafeF", sentiment: "positive", category: "market" },
      { symbol: null, title: "NHNN gi·ªØ nguy√™n l√£i su·∫•t ƒëi·ªÅu h√†nh", summary: "Ng√¢n h√†ng Nh√† n∆∞·ªõc quy·∫øt ƒë·ªãnh gi·ªØ nguy√™n c√°c m·ª©c l√£i su·∫•t ƒëi·ªÅu h√†nh.", source: "VnExpress", sentiment: "positive", category: "macro" },
      { symbol: null, title: "Kh·ªëi ngo·∫°i mua r√≤ng h∆°n 500 t·ª∑ ƒë·ªìng", summary: "D√≤ng ti·ªÅn t·ª´ c√°c qu·ªπ ETF ngo·∫°i ti·∫øp t·ª•c ch·∫£y v√†o th·ªã tr∆∞·ªùng Vi·ªát Nam.", source: "Vietstock", sentiment: "positive", category: "market" },
      { symbol: "VNM", title: "Vinamilk c√¥ng b·ªë k·∫øt qu·∫£ kinh doanh Q4/2024 v∆∞·ª£t k·ª≥ v·ªçng", summary: "Doanh thu v√† l·ª£i nhu·∫≠n c·ªßa Vinamilk trong qu√Ω 4/2024 ƒë·ªÅu v∆∞·ª£t d·ª± b√°o.", source: "CafeF", sentiment: "positive", category: "earnings" },
      { symbol: "VNM", title: "Vinamilk ƒë·∫©y m·∫°nh xu·∫•t kh·∫©u sang Trung Qu·ªëc", summary: "C√¥ng ty ƒëang m·ªü r·ªông k√™nh ph√¢n ph·ªëi t·∫°i Trung Qu·ªëc.", source: "VnExpress", sentiment: "positive", category: "business" },
      { symbol: "FPT", title: "FPT k√Ω h·ª£p ƒë·ªìng AI tr·ªã gi√° 100 tri·ªáu USD v·ªõi ƒë·ªëi t√°c Nh·∫≠t B·∫£n", summary: "FPT Corporation v·ª´a k√Ω k·∫øt h·ª£p ƒë·ªìng cung c·∫•p gi·∫£i ph√°p AI.", source: "ƒêTCK", sentiment: "positive", category: "business" },
      { symbol: "FPT", title: "FPT ƒë·∫∑t m·ª•c ti√™u doanh thu 2025 tƒÉng 25%", summary: "Ban l√£nh ƒë·∫°o FPT ƒë·∫∑t k·∫ø ho·∫°ch tƒÉng tr∆∞·ªüng doanh thu 25%.", source: "Vietstock", sentiment: "positive", category: "guidance" },
      { symbol: "VCB", title: "Vietcombank d·∫´n ƒë·∫ßu l·ª£i nhu·∫≠n ng√†nh ng√¢n h√†ng nƒÉm 2024", summary: "Vietcombank ti·∫øp t·ª•c gi·ªØ v·ªã tr√≠ qu√°n qu√¢n v·ªÅ l·ª£i nhu·∫≠n.", source: "CafeF", sentiment: "positive", category: "earnings" },
      { symbol: "HPG", title: "H√≤a Ph√°t: S·∫£n l∆∞·ª£ng th√©p th√°ng 11 ƒë·∫°t k·ª∑ l·ª•c m·ªõi", summary: "T·∫≠p ƒëo√†n H√≤a Ph√°t ghi nh·∫≠n s·∫£n l∆∞·ª£ng th√©p cao nh·∫•t l·ªãch s·ª≠.", source: "VnExpress", sentiment: "positive", category: "operations" },
      { symbol: "MBB", title: "MB Bank m·ªü r·ªông m·∫°ng l∆∞·ªõi chi nh√°nh t·∫°i mi·ªÅn Nam", summary: "Ng√¢n h√†ng Qu√¢n ƒë·ªôi ti·∫øp t·ª•c chi·∫øn l∆∞·ª£c m·ªü r·ªông.", source: "ƒêTCK", sentiment: "positive", category: "business" },
      { symbol: "TCB", title: "Techcombank: T·ª∑ l·ªá CASA duy tr√¨ tr√™n 40%", summary: "Techcombank ti·∫øp t·ª•c duy tr√¨ t·ª∑ l·ªá CASA cao nh·∫•t ng√†nh.", source: "Vietstock", sentiment: "positive", category: "financials" },
      { symbol: "ACB", title: "ACB tƒÉng c∆∞·ªùng cho vay ti√™u d√πng", summary: "Ng√¢n h√†ng ACB ƒë·∫©y m·∫°nh ph√¢n kh√∫c cho vay ti√™u d√πng.", source: "CafeF", sentiment: "positive", category: "business" },
      { symbol: "MSN", title: "Masan ho√†n t·∫•t t√°i c·∫•u tr√∫c", summary: "T·∫≠p ƒëo√†n Masan ƒë√£ ho√†n t·∫•t qu√° tr√¨nh t√°i c·∫•u tr√∫c.", source: "VnExpress", sentiment: "neutral", category: "business" },
      { symbol: "VIC", title: "Vingroup ƒë·∫©y m·∫°nh ph√°t tri·ªÉn VinFast t·∫°i M·ªπ", summary: "VinFast ti·∫øp t·ª•c m·ªü r·ªông m·∫°ng l∆∞·ªõi ƒë·∫°i l√Ω t·∫°i M·ªπ.", source: "ƒêTCK", sentiment: "positive", category: "business" },
      { symbol: "GAS", title: "PV GAS h∆∞·ªüng l·ª£i t·ª´ gi√° d·∫ßu tƒÉng", summary: "Gi√° d·∫ßu th·∫ø gi·ªõi tƒÉng gi√∫p PV GAS c·∫£i thi·ªán bi√™n l·ª£i nhu·∫≠n.", source: "Vietstock", sentiment: "positive", category: "earnings" }
    ];

    function aiSummary(s) {
      return s === 'positive' ? "Tin t·ª©c t√≠ch c·ª±c, h·ªó tr·ª£ t√¢m l√Ω nh√† ƒë·∫ßu t∆∞." : s === 'negative' ? "C·∫ßn theo d√µi s√°t di·ªÖn bi·∫øn." : "Th√¥ng tin trung t√≠nh.";
    }

    async function syncNews() {
      const resultEl = document.getElementById('syncResult');
      resultEl.innerHTML = '<span class="text-amber-400">Syncing...</span>';
      log('Starting sync...');

      const records = NEWS.map((n, i) => ({
        ...n, url: '', published_at: new Date(Date.now() - i * 21600000).toISOString(), ai_summary: aiSummary(n.sentiment)
      }));

      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/stock_news`, {
          method: 'POST',
          headers: {
            'apikey': SERVICE_KEY, 'Authorization': `Bearer ${SERVICE_KEY}`,
            'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates,return=minimal'
          },
          body: JSON.stringify(records)
        });

        if (response.ok) {
          resultEl.innerHTML = `<span class="text-emerald-400">‚úÖ ƒê√£ sync ${records.length} tin!</span>`;
          log(`Synced ${records.length} news!`, 'success');
        } else {
          const error = await response.text();
          resultEl.innerHTML = `<span class="text-rose-400">‚ùå Error: ${response.status}</span>`;
          log(`Error: ${error}`, 'error');
        }
      } catch (error) {
        resultEl.innerHTML = `<span class="text-rose-400">‚ùå ${error.message}</span>`;
        log(`Error: ${error.message}`, 'error');
      }
    }

    async function checkNews() {
      const resultEl = document.getElementById('checkResult');
      resultEl.innerHTML = '<span class="text-amber-400">Checking...</span>';

      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/stock_news?select=*&order=published_at.desc&limit=10`, {
          headers: { 'apikey': SERVICE_KEY, 'Authorization': `Bearer ${SERVICE_KEY}` }
        });

        if (response.ok) {
          const data = await response.json();
          resultEl.innerHTML = `<div class="text-emerald-400 mb-2">‚úÖ ${data.length} tin t·ª©c:</div>
            <div class="bg-slate-900 rounded-lg p-3 max-h-48 overflow-y-auto text-xs">
              ${data.map(n => `<div class="py-1 border-b border-slate-700">${n.symbol || 'Market'}: ${n.title}</div>`).join('')}
            </div>`;
          log(`Found ${data.length} news`, 'success');
        } else {
          resultEl.innerHTML = `<span class="text-rose-400">‚ùå Error</span>`;
          log('Error checking news', 'error');
        }
      } catch (error) {
        resultEl.innerHTML = `<span class="text-rose-400">‚ùå ${error.message}</span>`;
      }
    }

    log('Ready!', 'info');
  </script>
</body>
</html>

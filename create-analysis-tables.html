<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>T·∫°o B·∫£ng Ph√¢n T√≠ch AI - Supabase</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white min-h-screen p-8">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-2">üß† T·∫°o B·∫£ng Ph√¢n T√≠ch AI</h1>
    <p class="text-slate-400 mb-8">T·∫°o c√°c b·∫£ng: ai_analysis, risk_analysis, trading_strategy, broker_recommendations</p>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- B·∫£ng 1: AI Analysis -->
      <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
        <h3 class="text-lg font-bold text-indigo-400 mb-3">üìä ai_analysis</h3>
        <p class="text-sm text-slate-400 mb-3">Ch·∫©n ƒëo√°n SenAI (Rating, Score, Signal)</p>
        <ul class="text-xs text-slate-500 space-y-1">
          <li>‚Ä¢ rating (0-100)</li>
          <li>‚Ä¢ score (0-100)</li>
          <li>‚Ä¢ signal (0-100)</li>
          <li>‚Ä¢ recommendation (MUA/B√ÅN/N·∫ÆM GI·ªÆ)</li>
        </ul>
      </div>

      <!-- B·∫£ng 2: Risk Analysis -->
      <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
        <h3 class="text-lg font-bold text-emerald-400 mb-3">‚ö†Ô∏è risk_analysis</h3>
        <p class="text-sm text-slate-400 mb-3">X√°c su·∫•t & R·ªßi ro</p>
        <ul class="text-xs text-slate-500 space-y-1">
          <li>‚Ä¢ optimal_holding_days</li>
          <li>‚Ä¢ upside_probability (%)</li>
          <li>‚Ä¢ downside_risk (%)</li>
          <li>‚Ä¢ volatility, beta, sharpe_ratio</li>
        </ul>
      </div>

      <!-- B·∫£ng 3: Trading Strategy -->
      <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
        <h3 class="text-lg font-bold text-amber-400 mb-3">üéØ trading_strategy</h3>
        <p class="text-sm text-slate-400 mb-3">Chi·∫øn l∆∞·ª£c giao d·ªãch</p>
        <ul class="text-xs text-slate-500 space-y-1">
          <li>‚Ä¢ buy_zone_low, buy_zone_high</li>
          <li>‚Ä¢ stop_loss</li>
          <li>‚Ä¢ target_1, target_2, target_3</li>
          <li>‚Ä¢ support, resistance</li>
        </ul>
      </div>

      <!-- B·∫£ng 4: Broker Recommendations -->
      <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
        <h3 class="text-lg font-bold text-rose-400 mb-3">üè¶ broker_recommendations</h3>
        <p class="text-sm text-slate-400 mb-3">ƒê·ªìng thu·∫≠n t·ª´ CTCK</p>
        <ul class="text-xs text-slate-500 space-y-1">
          <li>‚Ä¢ broker_code (HSC, SSI, VCSC...)</li>
          <li>‚Ä¢ action (MUA/B√ÅN/N·∫ÆM GI·ªÆ)</li>
          <li>‚Ä¢ target_price</li>
          <li>‚Ä¢ rationale</li>
        </ul>
      </div>
    </div>

    <!-- Buttons -->
    <div class="flex gap-4 mb-8">
      <button onclick="createTables()" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-bold transition-colors">
        üöÄ T·∫°o T·∫•t C·∫£ B·∫£ng
      </button>
      <button onclick="insertSampleData()" class="px-6 py-3 bg-emerald-600 hover:bg-emerald-500 rounded-lg font-bold transition-colors">
        üìù Th√™m D·ªØ Li·ªáu M·∫´u
      </button>
      <button onclick="checkTables()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 rounded-lg font-bold transition-colors">
        üîç Ki·ªÉm Tra B·∫£ng
      </button>
    </div>

    <!-- Log -->
    <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
      <h3 class="text-lg font-bold mb-4">üìã Log</h3>
      <div id="log" class="font-mono text-sm space-y-2 max-h-96 overflow-y-auto"></div>
    </div>

    <!-- SQL Preview -->
    <div class="mt-8 bg-slate-800 rounded-xl p-6 border border-slate-700">
      <h3 class="text-lg font-bold mb-4">üìÑ SQL (Copy v√†o Supabase Dashboard n·∫øu c·∫ßn)</h3>
      <pre id="sqlPreview" class="text-xs text-slate-400 overflow-x-auto max-h-96 overflow-y-auto bg-slate-900 p-4 rounded-lg"></pre>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://trbiojajipzpqlnlghtt.supabase.co";
    // D√πng anon key - c·∫ßn th√™m policy INSERT tr√™n Supabase
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRyYmlvamFqaXB6cHFsbmxnaHR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMTg1NDEsImV4cCI6MjA4MTc5NDU0MX0.TOtVLQeFjes6NbnBTF6z-YPbFhSA-olvjJnAl60qhKQ";

    const headers = {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type': 'application/json',
      'Prefer': 'return=minimal'
    };

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const colors = {
        info: 'text-slate-300',
        success: 'text-emerald-400',
        error: 'text-rose-400',
        warning: 'text-amber-400'
      };
      logDiv.innerHTML += `<div class="${colors[type]}">${new Date().toLocaleTimeString()} - ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // SQL t·∫°o b·∫£ng
    const createTablesSql = `
-- 1. B·∫¢NG AI_ANALYSIS
CREATE TABLE IF NOT EXISTS ai_analysis (
  id SERIAL PRIMARY KEY,
  symbol VARCHAR(10) NOT NULL,
  analysis_date DATE NOT NULL DEFAULT CURRENT_DATE,
  rating INTEGER CHECK (rating >= 0 AND rating <= 100),
  score INTEGER CHECK (score >= 0 AND score <= 100),
  signal INTEGER CHECK (signal >= 0 AND signal <= 100),
  recommendation VARCHAR(20) CHECK (recommendation IN ('MUA', 'B√ÅN', 'N·∫ÆM GI·ªÆ', 'THEO D√ïI')),
  confidence DECIMAL(5,2),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(symbol, analysis_date)
);

-- 2. B·∫¢NG RISK_ANALYSIS
CREATE TABLE IF NOT EXISTS risk_analysis (
  id SERIAL PRIMARY KEY,
  symbol VARCHAR(10) NOT NULL,
  analysis_date DATE NOT NULL DEFAULT CURRENT_DATE,
  optimal_holding_days INTEGER,
  upside_probability DECIMAL(5,2),
  downside_risk DECIMAL(5,2),
  volatility DECIMAL(5,2),
  beta DECIMAL(5,2),
  sharpe_ratio DECIMAL(5,2),
  max_drawdown DECIMAL(5,2),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(symbol, analysis_date)
);

-- 3. B·∫¢NG TRADING_STRATEGY
CREATE TABLE IF NOT EXISTS trading_strategy (
  id SERIAL PRIMARY KEY,
  symbol VARCHAR(10) NOT NULL,
  analysis_date DATE NOT NULL DEFAULT CURRENT_DATE,
  buy_zone_low DECIMAL(12,2),
  buy_zone_high DECIMAL(12,2),
  stop_loss DECIMAL(12,2),
  target_1 DECIMAL(12,2),
  target_2 DECIMAL(12,2),
  target_3 DECIMAL(12,2),
  support_1 DECIMAL(12,2),
  support_2 DECIMAL(12,2),
  resistance_1 DECIMAL(12,2),
  resistance_2 DECIMAL(12,2),
  strategy_type VARCHAR(50),
  strategy_note TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(symbol, analysis_date)
);

-- 4. B·∫¢NG BROKER_RECOMMENDATIONS
CREATE TABLE IF NOT EXISTS broker_recommendations (
  id SERIAL PRIMARY KEY,
  symbol VARCHAR(10) NOT NULL,
  recommendation_date DATE NOT NULL,
  broker_code VARCHAR(20) NOT NULL,
  broker_name VARCHAR(100),
  action VARCHAR(20) CHECK (action IN ('MUA', 'B√ÅN', 'N·∫ÆM GI·ªÆ', 'KH·∫¢ QUAN', 'TRUNG L·∫¨P', 'TI√äU C·ª∞C')),
  target_price DECIMAL(12,2),
  previous_target DECIMAL(12,2),
  rationale TEXT,
  report_url VARCHAR(500),
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(symbol, recommendation_date, broker_code)
);

-- INDEX
CREATE INDEX IF NOT EXISTS idx_ai_analysis_symbol ON ai_analysis(symbol);
CREATE INDEX IF NOT EXISTS idx_risk_analysis_symbol ON risk_analysis(symbol);
CREATE INDEX IF NOT EXISTS idx_trading_strategy_symbol ON trading_strategy(symbol);
CREATE INDEX IF NOT EXISTS idx_broker_recommendations_symbol ON broker_recommendations(symbol);

-- RLS
ALTER TABLE ai_analysis ENABLE ROW LEVEL SECURITY;
ALTER TABLE risk_analysis ENABLE ROW LEVEL SECURITY;
ALTER TABLE trading_strategy ENABLE ROW LEVEL SECURITY;
ALTER TABLE broker_recommendations ENABLE ROW LEVEL SECURITY;

-- Policy
DROP POLICY IF EXISTS "Allow public read ai_analysis" ON ai_analysis;
DROP POLICY IF EXISTS "Allow public read risk_analysis" ON risk_analysis;
DROP POLICY IF EXISTS "Allow public read trading_strategy" ON trading_strategy;
DROP POLICY IF EXISTS "Allow public read broker_recommendations" ON broker_recommendations;

CREATE POLICY "Allow public read ai_analysis" ON ai_analysis FOR SELECT USING (true);
CREATE POLICY "Allow public read risk_analysis" ON risk_analysis FOR SELECT USING (true);
CREATE POLICY "Allow public read trading_strategy" ON trading_strategy FOR SELECT USING (true);
CREATE POLICY "Allow public read broker_recommendations" ON broker_recommendations FOR SELECT USING (true);
`;

    document.getElementById('sqlPreview').textContent = createTablesSql;

    async function createTables() {
      log('üöÄ B·∫Øt ƒë·∫ßu t·∫°o b·∫£ng...', 'info');
      log('‚ö†Ô∏è Supabase REST API kh√¥ng h·ªó tr·ª£ CREATE TABLE tr·ª±c ti·∫øp.', 'warning');
      log('üëâ Vui l√≤ng copy SQL ·ªü d∆∞·ªõi v√† ch·∫°y trong Supabase Dashboard > SQL Editor', 'warning');
      log('üìã SQL ƒë√£ ƒë∆∞·ª£c hi·ªÉn th·ªã b√™n d∆∞·ªõi', 'success');
    }

    async function insertSampleData() {
      log('üìù ƒêang th√™m d·ªØ li·ªáu m·∫´u...', 'info');

      const today = new Date().toISOString().split('T')[0];

      // Sample data cho c√°c m√£ VN100
      const symbols = ['VNM', 'HPG', 'FPT', 'VIC', 'VHM', 'MSN', 'TCB', 'VPB', 'MBB', 'ACB'];

      // 1. AI Analysis
      for (const symbol of symbols) {
        const aiData = {
          symbol,
          analysis_date: today,
          rating: Math.floor(Math.random() * 30) + 60,
          score: Math.floor(Math.random() * 20) + 75,
          signal: Math.floor(Math.random() * 40) + 40,
          recommendation: ['MUA', 'N·∫ÆM GI·ªÆ', 'THEO D√ïI'][Math.floor(Math.random() * 3)],
          confidence: (Math.random() * 20 + 70).toFixed(2)
        };

        try {
          const res = await fetch(`${SUPABASE_URL}/rest/v1/ai_analysis`, {
            method: 'POST',
            headers: { ...headers, 'Prefer': 'resolution=merge-duplicates' },
            body: JSON.stringify(aiData)
          });
          if (res.ok) {
            log(`‚úÖ ai_analysis: ${symbol}`, 'success');
          } else {
            const err = await res.text();
            log(`‚ùå ai_analysis ${symbol}: ${err}`, 'error');
          }
        } catch (e) {
          log(`‚ùå ai_analysis ${symbol}: ${e.message}`, 'error');
        }
      }

      // 2. Risk Analysis
      for (const symbol of symbols) {
        const riskData = {
          symbol,
          analysis_date: today,
          optimal_holding_days: Math.floor(Math.random() * 60) + 30,
          upside_probability: (Math.random() * 30 + 50).toFixed(2),
          downside_risk: (Math.random() * 20 + 20).toFixed(2),
          volatility: (Math.random() * 15 + 10).toFixed(2),
          beta: (Math.random() * 0.5 + 0.8).toFixed(2),
          sharpe_ratio: (Math.random() * 1 + 0.5).toFixed(2),
          max_drawdown: (Math.random() * 15 + 5).toFixed(2)
        };

        try {
          const res = await fetch(`${SUPABASE_URL}/rest/v1/risk_analysis`, {
            method: 'POST',
            headers: { ...headers, 'Prefer': 'resolution=merge-duplicates' },
            body: JSON.stringify(riskData)
          });
          if (res.ok) {
            log(`‚úÖ risk_analysis: ${symbol}`, 'success');
          } else {
            const err = await res.text();
            log(`‚ùå risk_analysis ${symbol}: ${err}`, 'error');
          }
        } catch (e) {
          log(`‚ùå risk_analysis ${symbol}: ${e.message}`, 'error');
        }
      }

      // 3. Trading Strategy
      const priceRanges = {
        'VNM': { base: 64000, range: 8000 },
        'HPG': { base: 26000, range: 4000 },
        'FPT': { base: 130000, range: 15000 },
        'VIC': { base: 42000, range: 5000 },
        'VHM': { base: 38000, range: 5000 },
        'MSN': { base: 75000, range: 10000 },
        'TCB': { base: 24000, range: 3000 },
        'VPB': { base: 19000, range: 2500 },
        'MBB': { base: 22000, range: 3000 },
        'ACB': { base: 24000, range: 3000 }
      };

      for (const symbol of symbols) {
        const p = priceRanges[symbol] || { base: 50000, range: 5000 };
        const strategyData = {
          symbol,
          analysis_date: today,
          buy_zone_low: p.base - p.range * 0.1,
          buy_zone_high: p.base + p.range * 0.05,
          stop_loss: p.base - p.range * 0.2,
          target_1: p.base + p.range * 0.15,
          target_2: p.base + p.range * 0.25,
          target_3: p.base + p.range * 0.4,
          support_1: p.base - p.range * 0.1,
          support_2: p.base - p.range * 0.2,
          resistance_1: p.base + p.range * 0.1,
          resistance_2: p.base + p.range * 0.2,
          strategy_type: 'Swing Trading',
          strategy_note: `Theo d√µi v√πng h·ªó tr·ª£ ${(p.base - p.range * 0.1).toLocaleString()} - ${(p.base - p.range * 0.2).toLocaleString()}`
        };

        try {
          const res = await fetch(`${SUPABASE_URL}/rest/v1/trading_strategy`, {
            method: 'POST',
            headers: { ...headers, 'Prefer': 'resolution=merge-duplicates' },
            body: JSON.stringify(strategyData)
          });
          if (res.ok) {
            log(`‚úÖ trading_strategy: ${symbol}`, 'success');
          } else {
            const err = await res.text();
            log(`‚ùå trading_strategy ${symbol}: ${err}`, 'error');
          }
        } catch (e) {
          log(`‚ùå trading_strategy ${symbol}: ${e.message}`, 'error');
        }
      }

      // 4. Broker Recommendations
      const brokers = [
        { code: 'HSC', name: 'C√¥ng ty CP Ch·ª©ng kho√°n TP.HCM' },
        { code: 'SSI', name: 'C√¥ng ty CP Ch·ª©ng kho√°n SSI' },
        { code: 'VCSC', name: 'C√¥ng ty CP Ch·ª©ng kho√°n B·∫£n Vi·ªát' },
        { code: 'FSC', name: 'C√¥ng ty CP Ch·ª©ng kho√°n FPT' },
        { code: 'VND', name: 'C√¥ng ty CP Ch·ª©ng kho√°n VNDirect' }
      ];

      for (const symbol of symbols.slice(0, 5)) {
        for (const broker of brokers.slice(0, 3)) {
          const p = priceRanges[symbol] || { base: 50000, range: 5000 };
          const brokerData = {
            symbol,
            recommendation_date: today,
            broker_code: broker.code,
            broker_name: broker.name,
            action: ['MUA', 'N·∫ÆM GI·ªÆ', 'KH·∫¢ QUAN'][Math.floor(Math.random() * 3)],
            target_price: p.base + p.range * (Math.random() * 0.3),
            rationale: `Tri·ªÉn v·ªçng tƒÉng tr∆∞·ªüng t√≠ch c·ª±c trong Q${Math.ceil(Math.random() * 4)}/2025`
          };

          try {
            const res = await fetch(`${SUPABASE_URL}/rest/v1/broker_recommendations`, {
              method: 'POST',
              headers: { ...headers, 'Prefer': 'resolution=merge-duplicates' },
              body: JSON.stringify(brokerData)
            });
            if (res.ok) {
              log(`‚úÖ broker_recommendations: ${symbol} - ${broker.code}`, 'success');
            } else {
              const err = await res.text();
              log(`‚ùå broker_recommendations ${symbol}: ${err}`, 'error');
            }
          } catch (e) {
            log(`‚ùå broker_recommendations ${symbol}: ${e.message}`, 'error');
          }
        }
      }

      log('üéâ Ho√†n th√†nh th√™m d·ªØ li·ªáu m·∫´u!', 'success');
    }

    async function checkTables() {
      log('üîç Ki·ªÉm tra c√°c b·∫£ng...', 'info');

      const tables = ['ai_analysis', 'risk_analysis', 'trading_strategy', 'broker_recommendations'];

      for (const table of tables) {
        try {
          const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?limit=1`, { headers });
          if (res.ok) {
            const data = await res.json();
            log(`‚úÖ ${table}: T·ªìn t·∫°i (${data.length > 0 ? 'c√≥ d·ªØ li·ªáu' : 'tr·ªëng'})`, 'success');
          } else {
            log(`‚ùå ${table}: Ch∆∞a t·ªìn t·∫°i ho·∫∑c l·ªói`, 'error');
          }
        } catch (e) {
          log(`‚ùå ${table}: ${e.message}`, 'error');
        }
      }
    }

    // Auto check on load
    checkTables();
  </script>
</body>
</html>

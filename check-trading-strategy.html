<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Check Trading Strategy Table</title>
  <style>
    body { font-family: system-ui; background: #0f172a; color: #e2e8f0; padding: 20px; }
    .card { background: #1e293b; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    h1 { color: #22d3ee; }
    h3 { color: #a78bfa; margin-top: 20px; }
    pre { background: #0f172a; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 12px; }
    .success { color: #10b981; }
    .error { color: #ef4444; }
    .warn { color: #f59e0b; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #334155; }
    th { background: #334155; color: #22d3ee; }
    .btn { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-right: 10px; }
    .btn:hover { background: #2563eb; }
  </style>
</head>
<body>
  <h1>üîç Check Trading Strategy Table</h1>
  
  <div class="card">
    <button class="btn" onclick="checkTable()">1. Ki·ªÉm tra c·∫•u tr√∫c b·∫£ng</button>
    <button class="btn" onclick="checkData()">2. Ki·ªÉm tra d·ªØ li·ªáu m·∫´u</button>
    <button class="btn" onclick="checkNewColumns()">3. Ki·ªÉm tra c·ªôt m·ªõi</button>
  </div>
  
  <div class="card">
    <h3>üìã K·∫øt qu·∫£</h3>
    <div id="result"></div>
  </div>

<script>
const SUPABASE_URL = "https://trbiojajipzpqlnlghtt.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRyYmlvamFqaXB6cHFsbmxnaHR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMTg1NDEsImV4cCI6MjA4MTc5NDU0MX0.TOtVLQeFjes6NbnBTF6z-YPbFhSA-olvjJnAl60qhKQ";

const headers = {
  "apikey": SUPABASE_KEY,
  "Authorization": `Bearer ${SUPABASE_KEY}`,
  "Content-Type": "application/json"
};

function log(html) {
  document.getElementById('result').innerHTML = html;
}

async function checkTable() {
  log('<p>ƒêang ki·ªÉm tra...</p>');
  
  try {
    // Try to get one record to see columns
    const res = await fetch(`${SUPABASE_URL}/rest/v1/trading_strategy?limit=1`, { headers });
    
    if (!res.ok) {
      const err = await res.text();
      log(`<p class="error">‚ùå L·ªói: ${err}</p><p>B·∫£ng trading_strategy c√≥ th·ªÉ ch∆∞a t·ªìn t·∫°i. C·∫ßn t·∫°o b·∫£ng tr∆∞·ªõc.</p>`);
      return;
    }
    
    const data = await res.json();
    
    if (data.length === 0) {
      log(`<p class="warn">‚ö†Ô∏è B·∫£ng trading_strategy t·ªìn t·∫°i nh∆∞ng ch∆∞a c√≥ d·ªØ li·ªáu.</p>
           <p>H√£y ch·∫°y sync-trading-strategy.html ƒë·ªÉ t·∫°o d·ªØ li·ªáu.</p>`);
      return;
    }
    
    const columns = Object.keys(data[0]);
    
    let html = `<p class="success">‚úÖ B·∫£ng trading_strategy t·ªìn t·∫°i v·ªõi ${columns.length} c·ªôt:</p>`;
    html += '<table><tr><th>#</th><th>T√™n c·ªôt</th><th>Gi√° tr·ªã m·∫´u</th></tr>';
    
    columns.forEach((col, i) => {
      const val = data[0][col];
      html += `<tr><td>${i+1}</td><td>${col}</td><td>${val !== null ? val : '<em>null</em>'}</td></tr>`;
    });
    
    html += '</table>';
    
    // Check for new columns
    const newCols = ['buy_zone_optimal', 'buy_zone_strength', 'stop_loss_percent', 'stop_loss_type', 
                     'target_1_percent', 'target_1_rr', 'target_2_percent', 'target_2_rr', 
                     'target_3_percent', 'target_3_rr', 'confidence'];
    
    const missingCols = newCols.filter(c => !columns.includes(c));
    
    if (missingCols.length > 0) {
      html += `<h3 class="warn">‚ö†Ô∏è Thi·∫øu ${missingCols.length} c·ªôt m·ªõi:</h3>`;
      html += `<pre>${missingCols.join('\n')}</pre>`;
      html += `<p>C·∫ßn ch·∫°y SQL ƒë·ªÉ th√™m c√°c c·ªôt n√†y.</p>`;
    } else {
      html += `<p class="success">‚úÖ T·∫•t c·∫£ c·ªôt m·ªõi ƒë√£ c√≥!</p>`;
    }
    
    log(html);
    
  } catch (err) {
    log(`<p class="error">‚ùå Error: ${err.message}</p>`);
  }
}

async function checkData() {
  log('<p>ƒêang ki·ªÉm tra d·ªØ li·ªáu...</p>');
  
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/trading_strategy?symbol=eq.HPG&order=analysis_date.desc&limit=1`, { headers });
    const data = await res.json();
    
    if (data.length === 0) {
      // Try another symbol
      const res2 = await fetch(`${SUPABASE_URL}/rest/v1/trading_strategy?order=analysis_date.desc&limit=5`, { headers });
      const data2 = await res2.json();
      
      if (data2.length === 0) {
        log(`<p class="warn">‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu trong b·∫£ng trading_strategy.</p>
             <p>H√£y m·ªü file <strong>sync-trading-strategy.html</strong> v√† click "B·∫Øt ƒë·∫ßu Sync".</p>`);
        return;
      }
      
      log(`<p class="success">‚úÖ C√≥ ${data2.length} records. V√≠ d·ª•:</p><pre>${JSON.stringify(data2[0], null, 2)}</pre>`);
      return;
    }
    
    const d = data[0];
    let html = `<h3 class="success">‚úÖ D·ªØ li·ªáu HPG:</h3>`;
    html += `<table>
      <tr><th>Tr∆∞·ªùng</th><th>Gi√° tr·ªã</th></tr>
      <tr><td>Symbol</td><td>${d.symbol}</td></tr>
      <tr><td>Ng√†y ph√¢n t√≠ch</td><td>${d.analysis_date}</td></tr>
      <tr><td>V√πng mua</td><td>${d.buy_zone_low?.toLocaleString()} - ${d.buy_zone_high?.toLocaleString()}</td></tr>
      <tr><td>ƒê·ªô m·∫°nh v√πng mua</td><td>${d.buy_zone_strength || '<em class="warn">ch∆∞a c√≥</em>'}</td></tr>
      <tr><td>C·∫Øt l·ªó</td><td>${d.stop_loss?.toLocaleString()}</td></tr>
      <tr><td>% C·∫Øt l·ªó</td><td>${d.stop_loss_percent ? d.stop_loss_percent + '%' : '<em class="warn">ch∆∞a c√≥</em>'}</td></tr>
      <tr><td>M·ª•c ti√™u 1</td><td>${d.target_1?.toLocaleString()}</td></tr>
      <tr><td>R:R M·ª•c ti√™u 1</td><td>${d.target_1_rr || '<em class="warn">ch∆∞a c√≥</em>'}</td></tr>
      <tr><td>M·ª•c ti√™u 2</td><td>${d.target_2?.toLocaleString()}</td></tr>
      <tr><td>R:R M·ª•c ti√™u 2</td><td>${d.target_2_rr || '<em class="warn">ch∆∞a c√≥</em>'}</td></tr>
      <tr><td>Chi·∫øn l∆∞·ª£c</td><td>${d.strategy_type}</td></tr>
      <tr><td>ƒê·ªô tin c·∫≠y</td><td>${d.confidence ? d.confidence + '%' : '<em class="warn">ch∆∞a c√≥</em>'}</td></tr>
    </table>`;
    
    // Check if new columns have data
    const hasNewData = d.buy_zone_strength && d.stop_loss_percent && d.target_1_rr;
    
    if (!hasNewData) {
      html += `<p class="warn">‚ö†Ô∏è D·ªØ li·ªáu c≈© - thi·∫øu c√°c tr∆∞·ªùng m·ªõi. C·∫ßn ch·∫°y l·∫°i sync!</p>`;
    } else {
      html += `<p class="success">‚úÖ D·ªØ li·ªáu ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng m·ªõi!</p>`;
    }
    
    log(html);
    
  } catch (err) {
    log(`<p class="error">‚ùå Error: ${err.message}</p>`);
  }
}

async function checkNewColumns() {
  log('<p>ƒêang ki·ªÉm tra c√°c c·ªôt m·ªõi...</p>');
  
  const newCols = [
    { name: 'buy_zone_optimal', type: 'DECIMAL(12,2)' },
    { name: 'buy_zone_strength', type: 'VARCHAR(20)' },
    { name: 'stop_loss_percent', type: 'DECIMAL(5,2)' },
    { name: 'stop_loss_type', type: 'VARCHAR(30)' },
    { name: 'target_1_percent', type: 'DECIMAL(5,2)' },
    { name: 'target_1_rr', type: 'DECIMAL(4,2)' },
    { name: 'target_2_percent', type: 'DECIMAL(5,2)' },
    { name: 'target_2_rr', type: 'DECIMAL(4,2)' },
    { name: 'target_3_percent', type: 'DECIMAL(5,2)' },
    { name: 'target_3_rr', type: 'DECIMAL(4,2)' },
    { name: 'confidence', type: 'DECIMAL(5,2)' }
  ];
  
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/trading_strategy?limit=1`, { headers });
    const data = await res.json();
    
    if (data.length === 0) {
      log(`<p class="warn">‚ö†Ô∏è B·∫£ng tr·ªëng, kh√¥ng th·ªÉ ki·ªÉm tra c·ªôt.</p>`);
      return;
    }
    
    const existingCols = Object.keys(data[0]);
    
    let html = '<h3>Ki·ªÉm tra c√°c c·ªôt m·ªõi c·∫ßn thi·∫øt:</h3><table><tr><th>C·ªôt</th><th>Tr·∫°ng th√°i</th></tr>';
    
    let missingCols = [];
    newCols.forEach(col => {
      const exists = existingCols.includes(col.name);
      html += `<tr><td>${col.name}</td><td class="${exists ? 'success' : 'error'}">${exists ? '‚úÖ C√≥' : '‚ùå Thi·∫øu'}</td></tr>`;
      if (!exists) missingCols.push(col);
    });
    
    html += '</table>';
    
    if (missingCols.length > 0) {
      html += `<h3 class="warn">‚ö†Ô∏è C·∫ßn th√™m ${missingCols.length} c·ªôt. Ch·∫°y SQL sau trong Supabase:</h3>`;
      html += '<pre>';
      missingCols.forEach(col => {
        html += `ALTER TABLE trading_strategy ADD COLUMN IF NOT EXISTS ${col.name} ${col.type};\n`;
      });
      html += '</pre>';
    } else {
      html += `<p class="success">‚úÖ T·∫•t c·∫£ c·ªôt m·ªõi ƒë√£ c√≥! B·∫°n c√≥ th·ªÉ ch·∫°y sync-trading-strategy.html ƒë·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu.</p>`;
    }
    
    log(html);
    
  } catch (err) {
    log(`<p class="error">‚ùå Error: ${err.message}</p>`);
  }
}

// Auto check on load
checkTable();
</script>
</body>
</html>

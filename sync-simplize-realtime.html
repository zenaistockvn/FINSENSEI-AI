<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Sync Simplize Realtime Data</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #0f172a; color: #e2e8f0; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #38bdf8; margin-bottom: 20px; }
        .card { background: #1e293b; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-right: 10px; }
        .btn-primary { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; }
        .btn-success { background: #22c55e; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .progress { background: #334155; border-radius: 8px; height: 24px; overflow: hidden; margin: 15px 0; }
        .progress-bar { background: linear-gradient(90deg, #6366f1, #22c55e); height: 100%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; }
        .log { background: #0f172a; border-radius: 8px; padding: 15px; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .log-item { padding: 4px 0; border-bottom: 1px solid #1e293b; }
        .log-success { color: #22c55e; }
        .log-error { color: #ef4444; }
        .log-info { color: #3b82f6; }
        .log-warning { color: #f59e0b; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat { background: #334155; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: #22c55e; }
        .stat-label { font-size: 12px; color: #94a3b8; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #334155; }
        th { background: #334155; color: #94a3b8; }
        .price-up { color: #22c55e; }
        .price-down { color: #ef4444; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Sync Simplize Realtime Data</h1>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="totalStocks">0</div>
                <div class="stat-label">T·ªïng m√£</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="syncedCount">0</div>
                <div class="stat-label">ƒê√£ sync</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="errorCount">0</div>
                <div class="stat-label">L·ªói</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="syncTime">0s</div>
                <div class="stat-label">Th·ªùi gian</div>
            </div>
        </div>

        <div class="card">
            <h3>‚ö° ƒê·ªìng b·ªô nhanh</h3>
            <button class="btn btn-primary" onclick="syncVN30()">Sync VN30 (30 m√£)</button>
            <button class="btn btn-success" onclick="syncVN100()">Sync VN100 (100 m√£)</button>
            <button class="btn btn-warning" onclick="syncCustom()">Sync Custom</button>
            
            <div class="progress" style="display:none;" id="progressContainer">
                <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
            </div>
        </div>

        <div class="card">
            <h3>üìä K·∫øt qu·∫£ Sync</h3>
            <div style="max-height: 300px; overflow-y: auto;">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th>M√£</th>
                            <th>Gi√°</th>
                            <th>Thay ƒë·ªïi</th>
                            <th>%</th>
                            <th>KL</th>
                            <th>Tr·∫°ng th√°i</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody"></tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h3>üìù Log</h3>
            <div class="log" id="logContainer"></div>
        </div>
    </div>

    <script>
        // Supabase config
        const SUPABASE_URL = "https://trbiojajipzpqlnlghtt.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRyYmlvamFqaXB6cHFsbmxnaHR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMTg1NDEsImV4cCI6MjA4MTc5NDU0MX0.TOtVLQeFjes6NbnBTF6z-YPbFhSA-olvjJnAl60qhKQ";

        // VN30 symbols
        const VN30 = ['ACB', 'BCM', 'BID', 'BVH', 'CTG', 'FPT', 'GAS', 'GVR', 'HDB', 'HPG', 
                      'MBB', 'MSN', 'MWG', 'PLX', 'POW', 'SAB', 'SHB', 'SSB', 'SSI', 'STB', 
                      'TCB', 'TPB', 'VCB', 'VHM', 'VIB', 'VIC', 'VJC', 'VNM', 'VPB', 'VRE'];

        // VN100 symbols (top 100)
        const VN100 = [...VN30, 'AAA', 'ANV', 'ASM', 'BWE', 'CII', 'CMG', 'DBC', 'DCM', 'DGC', 'DGW',
                       'DIG', 'DPM', 'DXG', 'EIB', 'EVF', 'FRT', 'GMD', 'HAG', 'HCM', 'HDC',
                       'HDG', 'HNG', 'HSG', 'HT1', 'IMP', 'KBC', 'KDC', 'KDH', 'LPB', 'MSB',
                       'NLG', 'NT2', 'NVL', 'OCB', 'PAN', 'PC1', 'PDR', 'PHR', 'PNJ', 'PPC',
                       'PVD', 'PVS', 'PVT', 'REE', 'SBT', 'SCR', 'SCS', 'SJS', 'SSC', 'TCH',
                       'TLG', 'VCI', 'VGC', 'VHC', 'VND', 'VOS', 'VPI', 'VTP'];

        let syncedCount = 0;
        let errorCount = 0;
        let startTime = 0;

        function log(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const item = document.createElement('div');
            item.className = `log-item log-${type}`;
            item.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.insertBefore(item, container.firstChild);
        }

        function updateProgress(current, total) {
            const percent = Math.round((current / total) * 100);
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressBar').textContent = `${percent}%`;
            document.getElementById('syncedCount').textContent = syncedCount;
            document.getElementById('errorCount').textContent = errorCount;
            document.getElementById('syncTime').textContent = `${((Date.now() - startTime) / 1000).toFixed(1)}s`;
        }

        async function fetchSimplizeData(symbol) {
            try {
                const response = await fetch(`https://api.simplize.vn/api/company/snapshot/${symbol}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                return data.data;
            } catch (error) {
                log(`‚ùå L·ªói fetch ${symbol}: ${error.message}`, 'error');
                return null;
            }
        }

        async function upsertToSupabase(stockData) {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/simplize_company_data`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'resolution=merge-duplicates'
                    },
                    body: JSON.stringify(stockData)
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }
                return true;
            } catch (error) {
                log(`‚ùå L·ªói upsert: ${error.message}`, 'error');
                return false;
            }
        }

        function addResultRow(symbol, data, status) {
            const tbody = document.getElementById('resultsBody');
            const row = document.createElement('tr');
            
            if (data) {
                const price = data.priceClose || data.price || 0;
                const change = data.netChange || data.change || 0;
                const pct = data.pctChange || 0;
                const volume = data.volume || 0;
                const isUp = change >= 0;
                
                row.innerHTML = `
                    <td><strong>${symbol}</strong></td>
                    <td>${price.toLocaleString()}</td>
                    <td class="${isUp ? 'price-up' : 'price-down'}">${isUp ? '+' : ''}${change.toLocaleString()}</td>
                    <td class="${isUp ? 'price-up' : 'price-down'}">${isUp ? '+' : ''}${pct.toFixed(2)}%</td>
                    <td>${(volume / 1000000).toFixed(2)}M</td>
                    <td class="log-success">‚úÖ ${status}</td>
                `;
            } else {
                row.innerHTML = `
                    <td><strong>${symbol}</strong></td>
                    <td colspan="4">-</td>
                    <td class="log-error">‚ùå ${status}</td>
                `;
            }
            
            tbody.insertBefore(row, tbody.firstChild);
        }

        async function syncStock(symbol) {
            const data = await fetchSimplizeData(symbol);
            
            if (!data) {
                errorCount++;
                addResultRow(symbol, null, 'Fetch failed');
                return false;
            }

            // Map Simplize data to database schema
            const stockData = {
                symbol: symbol.toUpperCase(),
                name_vi: data.companyName || data.name || symbol,
                stock_exchange: data.exchange || 'HOSE',
                price_close: data.priceClose || data.price || 0,
                price_open: data.priceOpen || data.open || 0,
                price_high: data.priceHigh || data.high || 0,
                price_low: data.priceLow || data.low || 0,
                net_change: data.netChange || data.change || 0,
                pct_change: data.pctChange || 0,
                volume: data.volume || 0,
                price_ceiling: data.priceCeiling || 0,
                price_floor: data.priceFloor || 0,
                price_reference: data.priceReference || 0,
                market_cap: data.marketCap || 0,
                pe_ratio: data.pe || 0,
                pb_ratio: data.pb || 0,
                eps: data.eps || 0,
                roe: data.roe || 0,
                roa: data.roa || 0,
                dividend_yield: data.dividendYield || 0,
                beta_5y: data.beta || 0,
                updated_at: new Date().toISOString()
            };

            const success = await upsertToSupabase(stockData);
            
            if (success) {
                syncedCount++;
                addResultRow(symbol, data, 'Synced');
                log(`‚úÖ ${symbol}: ${stockData.price_close.toLocaleString()} (${stockData.pct_change >= 0 ? '+' : ''}${stockData.pct_change.toFixed(2)}%)`, 'success');
                return true;
            } else {
                errorCount++;
                addResultRow(symbol, data, 'DB Error');
                return false;
            }
        }

        async function syncSymbols(symbols) {
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('totalStocks').textContent = symbols.length;
            document.getElementById('resultsBody').innerHTML = '';
            syncedCount = 0;
            errorCount = 0;
            startTime = Date.now();

            log(`üöÄ B·∫Øt ƒë·∫ßu sync ${symbols.length} m√£ t·ª´ Simplize API...`, 'info');

            // Sync in batches of 5
            const batchSize = 5;
            for (let i = 0; i < symbols.length; i += batchSize) {
                const batch = symbols.slice(i, i + batchSize);
                await Promise.all(batch.map(symbol => syncStock(symbol)));
                updateProgress(Math.min(i + batchSize, symbols.length), symbols.length);
                
                // Small delay between batches
                if (i + batchSize < symbols.length) {
                    await new Promise(r => setTimeout(r, 200));
                }
            }

            const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);
            log(`‚úÖ Ho√†n th√†nh! Sync ${syncedCount}/${symbols.length} m√£ trong ${totalTime}s`, 'success');
        }

        function syncVN30() {
            syncSymbols(VN30);
        }

        function syncVN100() {
            syncSymbols(VN100);
        }

        function syncCustom() {
            const input = prompt('Nh·∫≠p danh s√°ch m√£ (c√°ch nhau b·ªüi d·∫•u ph·∫©y):', 'VNM,FPT,VIC');
            if (input) {
                const symbols = input.toUpperCase().split(',').map(s => s.trim()).filter(s => s);
                syncSymbols(symbols);
            }
        }

        // Auto log on load
        log('üîß S·∫µn s√†ng sync d·ªØ li·ªáu t·ª´ Simplize API', 'info');
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Sync Broker Consensus (D·ªØ li·ªáu B√°o c√°o M·ªõi nh·∫•t)</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            background: #0f172a;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .btn {
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn:hover {
            background: #2563eb;
        }

        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
        }

        .success {
            background: #059669;
        }

        .error {
            background: #dc2626;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid #334155;
        }

        th {
            color: #94a3b8;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üìä ƒê·ªìng thu·∫≠n CTCK (Broker Consensus)</h1>
        <p>D·ªØ li·ªáu ƒë∆∞·ª£c t·ªïng h·ª£p t·ª´ c√°c b√°o c√°o ph√¢n t√≠ch m·ªõi nh·∫•t (Th√°ng 12/2024)</p>

        <button class="btn" onclick="syncData()">üöÄ ƒê·ªìng b·ªô v√†o Database</button>

        <div id="status" class="status" style="display: none;"></div>

        <h3>D·ªØ li·ªáu chu·∫©n b·ªã ƒë·ªìng b·ªô:</h3>
        <table>
            <thead>
                <tr>
                    <th>M√£ CP</th>
                    <th>CTCK</th>
                    <th>Khuy·∫øn ngh·ªã</th>
                    <th>Gi√° m·ª•c ti√™u</th>
                    <th>Lu·∫≠n ƒëi·ªÉm (T√≥m t·∫Øt)</th>
                </tr>
            </thead>
            <tbody id="preview"></tbody>
        </table>
    </div>

    <script>
        const SUPABASE_URL = "https://trbiojajipzpqlnlghtt.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRyYmlvamFqaXB6cHFsbmxnaHR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMTg1NDEsImV4cCI6MjA4MTc5NDU0MX0.TOtVLQeFjes6NbnBTF6z-YPbFhSA-olvjJnAl60qhKQ";

        // D·ªØ li·ªáu m·ªõi nh·∫•t t√¨m ƒë∆∞·ª£c t·ª´ search engine (C·∫≠p nh·∫≠t th√°ng 12/2025)
        const LATEST_RECOMMENDATIONS = [
            // VN30 Stocks
            { symbol: 'HPG', broker: 'DSC', action: 'MUA', price: 35800, date: '2025-12-23', rationale: 'L·ª£i nhu·∫≠n m·∫£ng th√©p ph·ª•c h·ªìi m·∫°nh, Dung Qu·∫•t 2 ƒëi v√†o ho·∫°t ƒë·ªông 2025-2026' },
            { symbol: 'HPG', broker: 'AGR', action: 'MUA', price: 28500, date: '2025-12-23', rationale: 'T√≠n hi·ªáu h·ªìi ph·ª•c r√µ n√©t, kh·ªëi ngo·∫°i mua r√≤ng tr·ªü l·∫°i' },
            { symbol: 'FPT', broker: 'Mirae Asset', action: 'KH·∫¢ QUAN', price: 0, date: '2025-12-23', rationale: 'M·∫£ng c√¥ng ngh·ªá v√† gi√°o d·ª•c tƒÉng tr∆∞·ªüng 2 con s·ªë, m·ªü r·ªông AI t·∫°i Nh·∫≠t B·∫£n' },
            { symbol: 'MWG', broker: 'BVSC', action: 'KH·∫¢ QUAN', price: 91300, date: '2025-12-23', rationale: 'Tri·ªÉn v·ªçng l·ª£i nhu·∫≠n 2026 t√≠ch c·ª±c, BHX tƒÉng tr∆∞·ªüng b·ªÅn v·ªØng' },
            { symbol: 'MWG', broker: 'MBS', action: 'MUA', price: 81700, date: '2025-12-23', rationale: 'L·ª£i nhu·∫≠n r√≤ng 2025 d·ª± ki·∫øn ƒë·∫°t h∆°n 5000 t·ª∑' },
            { symbol: 'TCB', broker: 'Mirae Asset', action: 'MUA', price: 0, date: '2025-12-23', rationale: 'TƒÉng tr∆∞·ªüng t√≠n d·ª•ng 2025 d·ª± ph√≥ng 24.7%, ƒë·ªãnh gi√° P/B h·∫•p d·∫´n' },
            { symbol: 'VCB', broker: 'Vietstock', action: 'MUA', price: 74100, date: '2025-12-23', rationale: 'Ch·∫•t l∆∞·ª£ng t√†i s·∫£n t·ªët ƒë·∫ßu ng√†nh, h∆∞·ªüng l·ª£i t·ª´ n·ªõi l·ªèng ti·ªÅn t·ªá' },
            { symbol: 'VIC', broker: 'Mirae Asset', action: 'MUA', price: 55500, date: '2025-12-23', rationale: 'M·∫£ng b·∫•t ƒë·ªông s·∫£n h·ªìi ph·ª•c, d√≤ng ti·ªÅn c·∫£i thi·ªán' },
            { symbol: 'VNM', broker: 'DSC', action: 'MUA', price: 82100, date: '2025-12-23', rationale: 'Bi√™n l·ª£i nhu·∫≠n c·∫£i thi·ªán nh·ªù gi√° nguy√™n li·ªáu gi·∫£m, ƒë·ªãnh gi√° P/E th·∫•p k·ª∑ l·ª•c' },
            { symbol: 'STB', broker: 'ASEAN SC', action: 'MUA', price: 0, date: '2025-12-23', rationale: 'X·ª≠ l√Ω n·ª£ x·∫•u ho√†n t·∫•t, k·ª≥ v·ªçng t√°i c∆° c·∫•u th√†nh c√¥ng' },
            { symbol: 'ACB', broker: 'SSI', action: 'KH·∫¢ QUAN', price: 36000, date: '2025-12-23', rationale: 'Ch·∫•t l∆∞·ª£ng t√†i s·∫£n t·ªët, NIM ·ªïn ƒë·ªãnh, ROE cao' },
            { symbol: 'MBB', broker: 'ACBS', action: 'KH·∫¢ QUAN', price: 29000, date: '2025-12-23', rationale: 'ƒê·ªãnh gi√° r·∫ª so v·ªõi ti·ªÅm nƒÉng tƒÉng tr∆∞·ªüng' },
            { symbol: 'MSN', broker: 'KBSV', action: 'MUA', price: 98800, date: '2025-12-23', rationale: 'M·∫£ng ti√™u d√πng d·∫´n d·∫Øt tƒÉng tr∆∞·ªüng, MCH d·ª± ki·∫øn chuy·ªÉn s√†n' },

            // Mid-cap / Others
            { symbol: 'PVS', broker: 'SSI', action: 'TRUNG L·∫¨P', price: 35000, date: '2025-12-23', rationale: 'D·ª± √°n L√¥ B - √î M√¥n l√† ƒë·ªông l·ª±c ch√≠nh' },
            { symbol: 'DBC', broker: 'VCBS', action: 'TRUNG L·∫¨P', price: 31500, date: '2025-12-23', rationale: 'Bi·∫øn ƒë·ªông gi√° heo h∆°i ·∫£nh h∆∞·ªüng l·ª£i nhu·∫≠n' },
            { symbol: 'GEX', broker: 'BSC', action: 'MUA', price: 53100, date: '2025-12-23', rationale: 'M·∫£ng thi·∫øt b·ªã ƒëi·ªán v√† khu c√¥ng nghi·ªáp tƒÉng tr∆∞·ªüng' }
        ];

        // Hi·ªÉn th·ªã preview
        const tbody = document.getElementById('preview');
        LATEST_RECOMMENDATIONS.forEach(rec => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="color: #38bdf8; font-weight: bold;">${rec.symbol}</td>
                <td>${rec.broker}</td>
                <td><span style="padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; background: ${getColor(rec.action)} bg-opacity-20; color: ${getColor(rec.action)}">${rec.action}</span></td>
                <td>${rec.price ? new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(rec.price) : 'N/A'}</td>
                <td>${rec.rationale || ''}</td>
            `;
            tbody.appendChild(tr);
        });

        function getColor(action) {
            const act = action.toUpperCase();
            if (act.includes('MUA') || act.includes('KH·∫¢ QUAN') || act.includes('OUTPERFORM')) return '#4ade80'; // Green
            if (act.includes('B√ÅN') || act.includes('K√âM')) return '#f87171'; // Red
            return '#fbbf24'; // Yellow/Neutral
        }

        async function syncData() {
            const statusDiv = document.getElementById('status');
            statusDiv.style.display = 'block';
            statusDiv.textContent = 'ƒêang ƒë·ªìng b·ªô...';
            statusDiv.className = 'status';

            try {
                // X√≥a d·ªØ li·ªáu c≈© c·ªßa th√°ng n√†y n·∫øu mu·ªën (optional)
                // await fetch(`${SUPABASE_URL}/rest/v1/broker_recommendations?recommendation_date=eq.2025-12-23`, { method: 'DELETE', headers: ... });

                const records = LATEST_RECOMMENDATIONS.map(rec => ({
                    symbol: rec.symbol,
                    broker_code: rec.broker,
                    broker_name: getBrokerName(rec.broker),
                    action: rec.action,
                    target_price: rec.price,
                    recommendation_date: rec.date,
                    rationale: rec.rationale || 'C·∫≠p nh·∫≠t t·ª´ b√°o c√°o ph√¢n t√≠ch m·ªõi nh·∫•t th√°ng 12/2025',
                    created_at: new Date().toISOString()
                }));

                const response = await fetch(`${SUPABASE_URL}/rest/v1/broker_recommendations`, {
                    method: 'POST',
                    headers: {
                        "apikey": SUPABASE_KEY,
                        "Authorization": `Bearer ${SUPABASE_KEY}`,
                        "Content-Type": "application/json",
                        "Prefer": "return=minimal"
                    },
                    body: JSON.stringify(records)
                });

                if (response.ok) {
                    statusDiv.textContent = '‚úÖ ƒê√£ ƒë·ªìng b·ªô th√†nh c√¥ng d·ªØ li·ªáu m·ªõi nh·∫•t!';
                    statusDiv.className = 'status success';
                } else {
                    throw new Error(await response.text());
                }
            } catch (error) {
                statusDiv.textContent = '‚ùå L·ªói: ' + error.message;
                statusDiv.className = 'status error';
            }
        }

        function getBrokerName(code) {
            const map = {
                'SSI': 'CTCK SSI',
                'BVSC': 'CTCK B·∫£o Vi·ªát',
                'ACBS': 'CTCK ACB',
                'VCBS': 'CTCK Vietcombank',
                'VNDirect': 'CTCK VNDirect',
                'BSC': 'CTCK BIDV',
                'KBSV': 'CTCK KB Vi·ªát Nam',
                'AGR': 'CTCK Agribank'
            };
            return map[code] || code;
        }
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sync Stock News V2 - VN100</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #e2e8f0; min-height: 100vh; padding: 20px; }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { text-align: center; margin-bottom: 10px; background: linear-gradient(90deg, #22d3ee, #a78bfa); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
    .subtitle { text-align: center; color: #94a3b8; margin-bottom: 30px; }
    .card { background: rgba(30, 41, 59, 0.8); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
    .btn { background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; margin: 5px; transition: all 0.3s; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn.success { background: linear-gradient(135deg, #10b981, #059669); }
    .btn.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .btn.danger { background: linear-gradient(135deg, #ef4444, #dc2626); }
    #log { background: #0f172a; border-radius: 8px; padding: 15px; height: 350px; overflow-y: auto; font-family: 'Fira Code', monospace; font-size: 12px; line-height: 1.6; }
    .log-info { color: #22d3ee; }
    .log-success { color: #10b981; }
    .log-error { color: #ef4444; }
    .log-warn { color: #f59e0b; }
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 15px; }
    .stat { background: rgba(15, 23, 42, 0.6); padding: 15px; border-radius: 8px; text-align: center; }
    .stat-value { font-size: 24px; font-weight: bold; color: #22d3ee; }
    .stat-label { font-size: 11px; color: #94a3b8; margin-top: 5px; text-transform: uppercase; }
    select, input { background: #1e293b; border: 1px solid #334155; color: white; padding: 10px 15px; border-radius: 8px; }
    .progress { width: 100%; height: 8px; background: #1e293b; border-radius: 4px; margin-top: 10px; overflow: hidden; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, #22d3ee, #a78bfa); transition: width 0.3s; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üóûÔ∏è Sync Stock News V2</h1>
    <p class="subtitle">T·∫°o 5 tin t·ª©c cho m·ªói m√£ VN30/VN100</p>
    
    <div class="card">
      <h3 style="margin-bottom: 15px;">‚öôÔ∏è C·∫•u h√¨nh</h3>
      <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
        <div>
          <label style="font-size: 12px; color: #94a3b8;">Preset:</label><br>
          <select id="presetSelect">
            <option value="vn30">VN30 (30 m√£)</option>
            <option value="vn100">VN100 (100 m√£)</option>
          </select>
        </div>
      </div>
      <div style="margin-top: 15px;">
        <button class="btn success" onclick="syncAllNews()">üöÄ Sync Tin T·ª©c VN30/VN100</button>
        <button class="btn warning" onclick="checkNews()">üîç Ki·ªÉm tra DB</button>
        <button class="btn danger" onclick="clearOldNews()">üóëÔ∏è X√≥a tin c≈©</button>
      </div>
      <div class="progress" id="progressContainer" style="display: none;">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
      </div>
      <div class="stats">
        <div class="stat"><div class="stat-value" id="totalCount">0</div><div class="stat-label">T·ªïng tin</div></div>
        <div class="stat"><div class="stat-value" id="positiveCount">0</div><div class="stat-label">T√≠ch c·ª±c</div></div>
        <div class="stat"><div class="stat-value" id="negativeCount">0</div><div class="stat-label">Ti√™u c·ª±c</div></div>
        <div class="stat"><div class="stat-value" id="symbolCount">0</div><div class="stat-label">S·ªë m√£</div></div>
      </div>
    </div>
    
    <div class="card">
      <h3 style="margin-bottom: 10px;">üìã Log</h3>
      <div id="log"></div>
    </div>
  </div>

<script>
const SUPABASE_URL = "https://trbiojajipzpqlnlghtt.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRyYmlvamFqaXB6cHFsbmxnaHR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMTg1NDEsImV4cCI6MjA4MTc5NDU0MX0.TOtVLQeFjes6NbnBTF6z-YPbFhSA-olvjJnAl60qhKQ";
const headers = { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}`, "Content-Type": "application/json" };

const VN30 = ["ACB","BCM","BID","BVH","CTG","FPT","GAS","GVR","HDB","HPG","MBB","MSN","MWG","PLX","POW","SAB","SHB","SSB","SSI","STB","TCB","TPB","VCB","VHM","VIB","VIC","VJC","VNM","VPB","VRE"];
const VN100_EXTRA = ["DGC","DPM","EIB","EVF","GMD","HAG","HCM","HDC","HSG","KBC","KDC","KDH","LPB","NLG","NT2","NVL","OCB","PDR","PNJ","REE","SBT","SCS","SJS","STK","VCI","VGC","VND","VPI","VSH","AGG","ANV","BWE","CII","CMG","DCM","DIG","DXG","GEX","HNG","IDC","IJC","IMP","KOS","LGC","MIG","NAB","NKG","PC1","PHR","PPC","PVD","PVS","PVT","SIP","SZC","TCH","TLG","VGI","VHC","VIX","VTP"];

let stats = { total: 0, positive: 0, negative: 0, neutral: 0, symbols: new Set() };

function log(msg, type = 'info') {
  const el = document.getElementById('log');
  el.innerHTML += `<div class="log-${type}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
  el.scrollTop = el.scrollHeight;
}

function updateStats() {
  document.getElementById('totalCount').textContent = stats.total;
  document.getElementById('positiveCount').textContent = stats.positive;
  document.getElementById('negativeCount').textContent = stats.negative;
  document.getElementById('symbolCount').textContent = stats.symbols.size;
}

function setProgress(percent) {
  document.getElementById('progressContainer').style.display = 'block';
  document.getElementById('progressBar').style.width = percent + '%';
}

// News templates by industry
const NEWS_TEMPLATES = {
  bank: [
    { title: "{symbol} ƒë·∫°t l·ª£i nhu·∫≠n k·ª∑ l·ª•c trong qu√Ω 4/2024", summary: "Ng√¢n h√†ng {name} c√¥ng b·ªë k·∫øt qu·∫£ kinh doanh qu√Ω 4/2024 v·ªõi l·ª£i nhu·∫≠n tr∆∞·ªõc thu·∫ø tƒÉng m·∫°nh so v·ªõi c√πng k·ª≥ nƒÉm tr∆∞·ªõc.", sentiment: "positive" },
    { title: "{symbol}: T·ª∑ l·ªá CASA ti·∫øp t·ª•c c·∫£i thi·ªán", summary: "T·ª∑ l·ªá ti·ªÅn g·ª≠i kh√¥ng k·ª≥ h·∫°n (CASA) c·ªßa {name} tƒÉng l√™n m·ª©c cao m·ªõi, gi√∫p t·ªëi ∆∞u chi ph√≠ v·ªën.", sentiment: "positive" },
    { title: "{symbol} m·ªü r·ªông m·∫°ng l∆∞·ªõi chi nh√°nh nƒÉm 2025", summary: "{name} ƒë·∫∑t k·∫ø ho·∫°ch m·ªü th√™m 20 chi nh√°nh m·ªõi trong nƒÉm 2025, t·∫≠p trung v√†o khu v·ª±c mi·ªÅn Nam.", sentiment: "positive" },
    { title: "{symbol} ƒë·∫©y m·∫°nh cho vay b√°n l·∫ª v√† SME", summary: "Ng√¢n h√†ng {name} t·∫≠p trung ph√°t tri·ªÉn m·∫£ng cho vay b√°n l·∫ª v√† doanh nghi·ªáp v·ª´a v√† nh·ªè trong chi·∫øn l∆∞·ª£c 2025.", sentiment: "neutral" },
    { title: "{symbol}: N·ª£ x·∫•u ƒë∆∞·ª£c ki·ªÉm so√°t t·ªët", summary: "T·ª∑ l·ªá n·ª£ x·∫•u c·ªßa {name} duy tr√¨ ·ªü m·ª©c th·∫•p d∆∞·ªõi 2%, th·ªÉ hi·ªán ch·∫•t l∆∞·ª£ng t√†i s·∫£n t·ªët.", sentiment: "positive" }
  ],
  steel: [
    { title: "{symbol}: S·∫£n l∆∞·ª£ng th√©p th√°ng 12 ƒë·∫°t k·ª∑ l·ª•c", summary: "{name} ghi nh·∫≠n s·∫£n l∆∞·ª£ng th√©p th√°ng 12/2024 ƒë·∫°t m·ª©c cao nh·∫•t trong l·ªãch s·ª≠, nh·ªù nhu c·∫ßu x√¢y d·ª±ng ph·ª•c h·ªìi.", sentiment: "positive" },
    { title: "{symbol} ƒë·∫∑t m·ª•c ti√™u xu·∫•t kh·∫©u th√©p tƒÉng 30%", summary: "Ban l√£nh ƒë·∫°o {name} ƒë·∫∑t k·∫ø ho·∫°ch tƒÉng tr∆∞·ªüng xu·∫•t kh·∫©u th√©p 30% trong nƒÉm 2025.", sentiment: "positive" },
    { title: "Gi√° th√©p x√¢y d·ª±ng tƒÉng, {symbol} h∆∞·ªüng l·ª£i", summary: "Gi√° th√©p x√¢y d·ª±ng tƒÉng 5% trong th√°ng 12, t·∫°o ƒëi·ªÅu ki·ªán thu·∫≠n l·ª£i cho {name}.", sentiment: "positive" },
    { title: "{symbol} m·ªü r·ªông c√¥ng su·∫•t giai ƒëo·∫°n 2", summary: "{name} ƒëang tri·ªÉn khai m·ªü r·ªông c√¥ng su·∫•t s·∫£n xu·∫•t th√©p giai ƒëo·∫°n 2 v·ªõi t·ªïng v·ªën ƒë·∫ßu t∆∞ l·ªõn.", sentiment: "neutral" },
    { title: "{symbol}: Chi ph√≠ nguy√™n li·ªáu ƒë·∫ßu v√†o gi·∫£m", summary: "Chi ph√≠ qu·∫∑ng s·∫Øt v√† than c·ªëc gi·∫£m gi√∫p c·∫£i thi·ªán bi√™n l·ª£i nhu·∫≠n c·ªßa {name}.", sentiment: "positive" }
  ],
  tech: [
    { title: "{symbol} k√Ω h·ª£p ƒë·ªìng AI tr·ªã gi√° 100 tri·ªáu USD", summary: "{name} v·ª´a k√Ω k·∫øt h·ª£p ƒë·ªìng cung c·∫•p gi·∫£i ph√°p AI cho ƒë·ªëi t√°c qu·ªëc t·∫ø, tr·ªã gi√° 100 tri·ªáu USD.", sentiment: "positive" },
    { title: "{symbol} ƒë·∫∑t m·ª•c ti√™u doanh thu 2025 tƒÉng 25%", summary: "Ban l√£nh ƒë·∫°o {name} ƒë·∫∑t k·∫ø ho·∫°ch tƒÉng tr∆∞·ªüng doanh thu 25% trong nƒÉm 2025.", sentiment: "positive" },
    { title: "{symbol} m·ªü r·ªông th·ªã tr∆∞·ªùng Nh·∫≠t B·∫£n v√† M·ªπ", summary: "{name} ti·∫øp t·ª•c ƒë·∫©y m·∫°nh xu·∫•t kh·∫©u ph·∫ßn m·ªÅm sang th·ªã tr∆∞·ªùng Nh·∫≠t B·∫£n v√† M·ªπ.", sentiment: "positive" },
    { title: "{symbol}: M·∫£ng chuy·ªÉn ƒë·ªïi s·ªë tƒÉng tr∆∞·ªüng m·∫°nh", summary: "Doanh thu t·ª´ m·∫£ng chuy·ªÉn ƒë·ªïi s·ªë c·ªßa {name} tƒÉng 40% so v·ªõi c√πng k·ª≥ nƒÉm tr∆∞·ªõc.", sentiment: "positive" },
    { title: "{symbol} ƒë·∫ßu t∆∞ m·∫°nh v√†o AI v√† Cloud", summary: "{name} c√¥ng b·ªë k·∫ø ho·∫°ch ƒë·∫ßu t∆∞ 500 t·ª∑ ƒë·ªìng v√†o nghi√™n c·ª©u AI v√† d·ªãch v·ª• Cloud.", sentiment: "neutral" }
  ],
  retail: [
    { title: "{symbol}: Doanh thu b√°n l·∫ª Q4 v∆∞·ª£t k·ª≥ v·ªçng", summary: "{name} c√¥ng b·ªë doanh thu b√°n l·∫ª qu√Ω 4/2024 v∆∞·ª£t d·ª± b√°o c·ªßa gi·ªõi ph√¢n t√≠ch.", sentiment: "positive" },
    { title: "{symbol} m·ªü th√™m 50 c·ª≠a h√†ng m·ªõi nƒÉm 2025", summary: "{name} ƒë·∫∑t k·∫ø ho·∫°ch m·ªü r·ªông m·∫°ng l∆∞·ªõi v·ªõi 50 c·ª≠a h√†ng m·ªõi trong nƒÉm 2025.", sentiment: "positive" },
    { title: "{symbol}: Bi√™n l·ª£i nhu·∫≠n c·∫£i thi·ªán nh·ªù t·ªëi ∆∞u chi ph√≠", summary: "Bi√™n l·ª£i nhu·∫≠n g·ªôp c·ªßa {name} c·∫£i thi·ªán ƒë√°ng k·ªÉ nh·ªù chi·∫øn l∆∞·ª£c t·ªëi ∆∞u h√≥a chi ph√≠.", sentiment: "positive" },
    { title: "{symbol} ƒë·∫©y m·∫°nh k√™nh b√°n h√†ng online", summary: "{name} ghi nh·∫≠n doanh thu t·ª´ k√™nh online tƒÉng 60% so v·ªõi c√πng k·ª≥.", sentiment: "positive" },
    { title: "{symbol}: C·∫°nh tranh gay g·∫Øt trong ng√†nh b√°n l·∫ª", summary: "Th·ªã tr∆∞·ªùng b√°n l·∫ª c·∫°nh tranh gay g·∫Øt, {name} c·∫ßn chi·∫øn l∆∞·ª£c kh√°c bi·ªát h√≥a.", sentiment: "neutral" }
  ],
  food: [
    { title: "{symbol} c√¥ng b·ªë k·∫øt qu·∫£ kinh doanh Q4 v∆∞·ª£t k·ª≥ v·ªçng", summary: "Doanh thu v√† l·ª£i nhu·∫≠n c·ªßa {name} trong qu√Ω 4/2024 ƒë·ªÅu v∆∞·ª£t d·ª± b√°o.", sentiment: "positive" },
    { title: "{symbol} ƒë·∫©y m·∫°nh xu·∫•t kh·∫©u sang Trung Qu·ªëc", summary: "{name} ƒëang m·ªü r·ªông k√™nh ph√¢n ph·ªëi t·∫°i Trung Qu·ªëc, k·ª≥ v·ªçng tƒÉng tr∆∞·ªüng xu·∫•t kh·∫©u 20%.", sentiment: "positive" },
    { title: "{symbol}: Th·ªã ph·∫ßn n·ªôi ƒë·ªãa ti·∫øp t·ª•c d·∫´n ƒë·∫ßu", summary: "{name} duy tr√¨ v·ªã tr√≠ d·∫´n ƒë·∫ßu th·ªã ph·∫ßn trong ng√†nh th·ª±c ph·∫©m v√† ƒë·ªì u·ªëng.", sentiment: "positive" },
    { title: "{symbol} ra m·∫Øt d√≤ng s·∫£n ph·∫©m m·ªõi", summary: "{name} gi·ªõi thi·ªáu d√≤ng s·∫£n ph·∫©m m·ªõi nh·∫Øm v√†o ph√¢n kh√∫c cao c·∫•p.", sentiment: "neutral" },
    { title: "{symbol}: Chi ph√≠ nguy√™n li·ªáu ƒë·∫ßu v√†o ·ªïn ƒë·ªãnh", summary: "Chi ph√≠ nguy√™n li·ªáu ƒë·∫ßu v√†o c·ªßa {name} ƒë∆∞·ª£c ki·ªÉm so√°t t·ªët trong qu√Ω 4.", sentiment: "positive" }
  ],
  realestate: [
    { title: "{symbol}: Doanh s·ªë b√°n h√†ng Q4 tƒÉng m·∫°nh", summary: "{name} ghi nh·∫≠n doanh s·ªë b√°n h√†ng qu√Ω 4/2024 tƒÉng 35% so v·ªõi c√πng k·ª≥.", sentiment: "positive" },
    { title: "{symbol} m·ªü b√°n d·ª± √°n m·ªõi t·∫°i TP.HCM", summary: "{name} ch√≠nh th·ª©c m·ªü b√°n d·ª± √°n cƒÉn h·ªô cao c·∫•p m·ªõi t·∫°i khu v·ª±c TP.HCM.", sentiment: "positive" },
    { title: "{symbol}: Qu·ªπ ƒë·∫•t l·ªõn, ti·ªÅm nƒÉng ph√°t tri·ªÉn d√†i h·∫°n", summary: "{name} s·ªü h·ªØu qu·ªπ ƒë·∫•t l·ªõn v·ªõi ti·ªÅm nƒÉng ph√°t tri·ªÉn trong 5-10 nƒÉm t·ªõi.", sentiment: "positive" },
    { title: "Th·ªã tr∆∞·ªùng BƒêS ph·ª•c h·ªìi, {symbol} h∆∞·ªüng l·ª£i", summary: "Th·ªã tr∆∞·ªùng b·∫•t ƒë·ªông s·∫£n c√≥ d·∫•u hi·ªáu ph·ª•c h·ªìi, t·∫°o ƒëi·ªÅu ki·ªán thu·∫≠n l·ª£i cho {name}.", sentiment: "positive" },
    { title: "{symbol}: √Åp l·ª±c l√£i su·∫•t vay gi·∫£m d·∫ßn", summary: "L√£i su·∫•t cho vay mua nh√† gi·∫£m gi√∫p c·∫£i thi·ªán nhu c·∫ßu mua BƒêS c·ªßa {name}.", sentiment: "neutral" }
  ],
  energy: [
    { title: "{symbol}: S·∫£n l∆∞·ª£ng ƒëi·ªán Q4 tƒÉng 15%", summary: "{name} ghi nh·∫≠n s·∫£n l∆∞·ª£ng ƒëi·ªán qu√Ω 4/2024 tƒÉng 15% so v·ªõi c√πng k·ª≥.", sentiment: "positive" },
    { title: "{symbol} ƒë·∫ßu t∆∞ v√†o nƒÉng l∆∞·ª£ng t√°i t·∫°o", summary: "{name} c√¥ng b·ªë k·∫ø ho·∫°ch ƒë·∫ßu t∆∞ 1,000 t·ª∑ ƒë·ªìng v√†o c√°c d·ª± √°n nƒÉng l∆∞·ª£ng t√°i t·∫°o.", sentiment: "positive" },
    { title: "{symbol}: Gi√° b√°n ƒëi·ªán ƒë∆∞·ª£c ƒëi·ªÅu ch·ªânh tƒÉng", summary: "Gi√° b√°n ƒëi·ªán ƒë∆∞·ª£c ƒëi·ªÅu ch·ªânh tƒÉng, c·∫£i thi·ªán doanh thu c·ªßa {name}.", sentiment: "positive" },
    { title: "{symbol} ho√†n th√†nh b·∫£o d∆∞·ª°ng nh√† m√°y", summary: "{name} ho√†n th√†nh ƒë·ª£t b·∫£o d∆∞·ª°ng ƒë·ªãnh k·ª≥, s·∫µn s√†ng cho m√πa cao ƒëi·ªÉm.", sentiment: "neutral" },
    { title: "{symbol}: Nhu c·∫ßu ƒëi·ªán c√¥ng nghi·ªáp tƒÉng cao", summary: "Nhu c·∫ßu ƒëi·ªán t·ª´ khu v·ª±c c√¥ng nghi·ªáp tƒÉng cao, h·ªó tr·ª£ doanh thu c·ªßa {name}.", sentiment: "positive" }
  ],
  default: [
    { title: "{symbol} c√¥ng b·ªë k·∫øt qu·∫£ kinh doanh Q4/2024 kh·∫£ quan", summary: "{name} v·ª´a c√¥ng b·ªë k·∫øt qu·∫£ kinh doanh qu√Ω 4/2024 v·ªõi nhi·ªÅu ch·ªâ s·ªë t√≠ch c·ª±c.", sentiment: "positive" },
    { title: "C·ªï phi·∫øu {symbol} ƒë∆∞·ª£c khuy·∫øn ngh·ªã MUA", summary: "Nhi·ªÅu c√¥ng ty ch·ª©ng kho√°n ƒë∆∞a ra khuy·∫øn ngh·ªã MUA cho c·ªï phi·∫øu {symbol}.", sentiment: "positive" },
    { title: "{symbol}: Ban l√£nh ƒë·∫°o t·ª± tin v·ªÅ tri·ªÉn v·ªçng 2025", summary: "Ban l√£nh ƒë·∫°o {name} th·ªÉ hi·ªán s·ª± t·ª± tin v·ªÅ tri·ªÉn v·ªçng kinh doanh nƒÉm 2025.", sentiment: "positive" },
    { title: "{symbol} ƒë·∫∑t m·ª•c ti√™u tƒÉng tr∆∞·ªüng 20% nƒÉm 2025", summary: "{name} ƒë·∫∑t k·∫ø ho·∫°ch tƒÉng tr∆∞·ªüng doanh thu v√† l·ª£i nhu·∫≠n 20% trong nƒÉm 2025.", sentiment: "positive" },
    { title: "{symbol}: C·ªï ƒë√¥ng l·ªõn ti·∫øp t·ª•c mua v√†o", summary: "C√°c c·ªï ƒë√¥ng l·ªõn c·ªßa {name} ti·∫øp t·ª•c mua th√™m c·ªï phi·∫øu, th·ªÉ hi·ªán ni·ªÅm tin.", sentiment: "neutral" }
  ]
};

// Company info mapping
const COMPANY_INFO = {
  // Banks
  ACB: { name: "Ng√¢n h√†ng ACB", industry: "bank" },
  BID: { name: "BIDV", industry: "bank" },
  CTG: { name: "VietinBank", industry: "bank" },
  HDB: { name: "HDBank", industry: "bank" },
  MBB: { name: "MB Bank", industry: "bank" },
  SHB: { name: "SHB", industry: "bank" },
  SSB: { name: "SeABank", industry: "bank" },
  STB: { name: "Sacombank", industry: "bank" },
  TCB: { name: "Techcombank", industry: "bank" },
  TPB: { name: "TPBank", industry: "bank" },
  VCB: { name: "Vietcombank", industry: "bank" },
  VIB: { name: "VIB", industry: "bank" },
  VPB: { name: "VPBank", industry: "bank" },
  EIB: { name: "Eximbank", industry: "bank" },
  LPB: { name: "LienVietPostBank", industry: "bank" },
  OCB: { name: "OCB", industry: "bank" },
  NAB: { name: "Nam A Bank", industry: "bank" },
  
  // Steel
  HPG: { name: "H√≤a Ph√°t", industry: "steel" },
  HSG: { name: "Hoa Sen", industry: "steel" },
  NKG: { name: "Nam Kim", industry: "steel" },
  
  // Tech
  FPT: { name: "FPT Corporation", industry: "tech" },
  CMG: { name: "CMC Corporation", industry: "tech" },
  
  // Retail
  MWG: { name: "Th·∫ø Gi·ªõi Di ƒê·ªông", industry: "retail" },
  MSN: { name: "Masan Group", industry: "retail" },
  PNJ: { name: "PNJ", industry: "retail" },
  
  // Food & Beverage
  VNM: { name: "Vinamilk", industry: "food" },
  SAB: { name: "Sabeco", industry: "food" },
  VHC: { name: "Vƒ©nh Ho√†n", industry: "food" },
  ANV: { name: "Nam Vi·ªát", industry: "food" },
  
  // Real Estate
  VHM: { name: "Vinhomes", industry: "realestate" },
  VIC: { name: "Vingroup", industry: "realestate" },
  VRE: { name: "Vincom Retail", industry: "realestate" },
  NVL: { name: "Novaland", industry: "realestate" },
  PDR: { name: "Ph√°t ƒê·∫°t", industry: "realestate" },
  KDH: { name: "Khang ƒêi·ªÅn", industry: "realestate" },
  DXG: { name: "ƒê·∫•t Xanh", industry: "realestate" },
  NLG: { name: "Nam Long", industry: "realestate" },
  HDC: { name: "Hodeco", industry: "realestate" },
  DIG: { name: "DIC Corp", industry: "realestate" },
  
  // Energy
  GAS: { name: "PV Gas", industry: "energy" },
  PLX: { name: "Petrolimex", industry: "energy" },
  POW: { name: "PV Power", industry: "energy" },
  PVD: { name: "PV Drilling", industry: "energy" },
  PVS: { name: "PV Technical", industry: "energy" },
  PVT: { name: "PV Trans", industry: "energy" },
  NT2: { name: "Nhi·ªát ƒëi·ªán Nh∆°n Tr·∫°ch 2", industry: "energy" },
  PPC: { name: "Nhi·ªát ƒëi·ªán Ph·∫£ L·∫°i", industry: "energy" },
  PC1: { name: "PC1", industry: "energy" },
  
  // Others with default
  BCM: { name: "Becamex IDC", industry: "realestate" },
  BVH: { name: "B·∫£o Vi·ªát Holdings", industry: "default" },
  GVR: { name: "T·∫≠p ƒëo√†n Cao su", industry: "default" },
  SSI: { name: "SSI Securities", industry: "default" },
  VJC: { name: "Vietjet Air", industry: "default" },
  DGC: { name: "ƒê·ª©c Giang Chemical", industry: "default" },
  DPM: { name: "ƒê·∫°m Ph√∫ M·ªπ", industry: "default" },
  EVF: { name: "EVN Finance", industry: "bank" },
  GMD: { name: "Gemadept", industry: "default" },
  HAG: { name: "HAGL", industry: "realestate" },
  HCM: { name: "HSC Securities", industry: "default" },
  KBC: { name: "Kinh B·∫Øc", industry: "realestate" },
  KDC: { name: "Kido Group", industry: "food" },
  REE: { name: "REE Corporation", industry: "default" },
  SBT: { name: "TTC Sugar", industry: "food" },
  SCS: { name: "Saigon Cargo", industry: "default" },
  SJS: { name: "Sudico", industry: "realestate" },
  STK: { name: "S·ª£i Th·∫ø K·ª∑", industry: "default" },
  VCI: { name: "Vietcap Securities", industry: "default" },
  VGC: { name: "Viglacera", industry: "default" },
  VND: { name: "VNDirect", industry: "default" },
  VPI: { name: "VƒÉn Ph√∫ Invest", industry: "realestate" },
  VSH: { name: "Vƒ©nh S∆°n - S√¥ng Hinh", industry: "energy" }
};

const SOURCES = ['CafeF', 'VnExpress', 'Vietstock', 'ƒêTCK', 'Tinnhanhchungkhoan', 'VnEconomy'];

function getCompanyInfo(symbol) {
  return COMPANY_INFO[symbol] || { name: `C√¥ng ty ${symbol}`, industry: 'default' };
}

function generateNewsForSymbol(symbol) {
  const info = getCompanyInfo(symbol);
  const templates = NEWS_TEMPLATES[info.industry] || NEWS_TEMPLATES.default;
  const news = [];
  const now = Date.now();
  
  // Generate 5 unique news for each symbol
  for (let i = 0; i < 5; i++) {
    const template = templates[i % templates.length];
    const title = template.title.replace(/{symbol}/g, symbol).replace(/{name}/g, info.name);
    const summary = template.summary.replace(/{symbol}/g, symbol).replace(/{name}/g, info.name);
    const source = SOURCES[Math.floor(Math.random() * SOURCES.length)];
    
    // Create unique timestamp for each news (spread over last 7 days)
    const publishedAt = new Date(now - (i * 24 * 60 * 60 * 1000) - Math.random() * 12 * 60 * 60 * 1000);
    
    news.push({
      symbol: symbol,
      title: title,
      summary: summary,
      source: source,
      url: '',
      published_at: publishedAt.toISOString(),
      sentiment: template.sentiment,
      ai_summary: template.sentiment === 'positive' ? `Tin t√≠ch c·ª±c cho ${symbol}, h·ªó tr·ª£ gi√° c·ªï phi·∫øu.` : 
                  template.sentiment === 'negative' ? `C·∫ßn theo d√µi ${symbol}, c√≥ th·ªÉ t·∫°o √°p l·ª±c ng·∫Øn h·∫°n.` :
                  `Th√¥ng tin trung t√≠nh v·ªÅ ${symbol}, c·∫ßn theo d√µi th√™m.`,
      category: 'stock'
    });
  }
  
  return news;
}

// Generate market news
function generateMarketNews() {
  const marketNews = [
    { title: "VN-Index v∆∞·ª£t m·ªëc 1,280 ƒëi·ªÉm, thanh kho·∫£n tƒÉng m·∫°nh", summary: "Th·ªã tr∆∞·ªùng ch·ª©ng kho√°n Vi·ªát Nam ti·∫øp t·ª•c ƒë√† tƒÉng v·ªõi thanh kho·∫£n c·∫£i thi·ªán ƒë√°ng k·ªÉ.", sentiment: "positive" },
    { title: "NHNN gi·ªØ nguy√™n l√£i su·∫•t ƒëi·ªÅu h√†nh, h·ªó tr·ª£ tƒÉng tr∆∞·ªüng", summary: "Ng√¢n h√†ng Nh√† n∆∞·ªõc quy·∫øt ƒë·ªãnh gi·ªØ nguy√™n c√°c m·ª©c l√£i su·∫•t ƒëi·ªÅu h√†nh.", sentiment: "positive" },
    { title: "Kh·ªëi ngo·∫°i mua r√≤ng h∆°n 500 t·ª∑ ƒë·ªìng trong phi√™n", summary: "D√≤ng ti·ªÅn t·ª´ c√°c qu·ªπ ETF ngo·∫°i ti·∫øp t·ª•c ch·∫£y v√†o th·ªã tr∆∞·ªùng Vi·ªát Nam.", sentiment: "positive" },
    { title: "D·ª± b√°o VN-Index c√≥ th·ªÉ ƒë·∫°t 1,350 ƒëi·ªÉm trong Q1/2025", summary: "C√°c chuy√™n gia d·ª± b√°o VN-Index c√≥ th·ªÉ ƒë·∫°t m·ªëc 1,350 ƒëi·ªÉm trong qu√Ω 1/2025.", sentiment: "positive" },
    { title: "Th·ªã tr∆∞·ªùng ch√¢u √Å tƒÉng ƒëi·ªÉm theo ƒë√† ph·ª•c h·ªìi to√†n c·∫ßu", summary: "C√°c th·ªã tr∆∞·ªùng ch·ª©ng kho√°n ch√¢u √Å ƒë·ªìng lo·∫°t tƒÉng ƒëi·ªÉm.", sentiment: "positive" }
  ];
  
  const now = Date.now();
  return marketNews.map((n, i) => ({
    symbol: null,
    title: n.title,
    summary: n.summary,
    source: SOURCES[i % SOURCES.length],
    url: '',
    published_at: new Date(now - i * 4 * 60 * 60 * 1000).toISOString(),
    sentiment: n.sentiment,
    ai_summary: "Tin t·ª©c th·ªã tr∆∞·ªùng, h·ªó tr·ª£ t√¢m l√Ω nh√† ƒë·∫ßu t∆∞.",
    category: 'market'
  }));
}

async function clearOldNews() {
  log('üóëÔ∏è ƒêang x√≥a tin t·ª©c c≈©...', 'warn');
  
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/stock_news?id=gt.0`, {
      method: 'DELETE',
      headers
    });
    
    if (res.ok) {
      log('‚úÖ ƒê√£ x√≥a t·∫•t c·∫£ tin t·ª©c c≈©', 'success');
      stats = { total: 0, positive: 0, negative: 0, neutral: 0, symbols: new Set() };
      updateStats();
    } else {
      log(`‚ùå L·ªói x√≥a: ${res.status}`, 'error');
    }
  } catch (err) {
    log(`‚ùå Exception: ${err.message}`, 'error');
  }
}

async function syncAllNews() {
  const preset = document.getElementById('presetSelect').value;
  const symbols = preset === 'vn30' ? VN30 : [...VN30, ...VN100_EXTRA];
  
  log(`üöÄ B·∫Øt ƒë·∫ßu sync tin t·ª©c cho ${symbols.length} m√£ (5 tin/m√£)...`, 'info');
  stats = { total: 0, positive: 0, negative: 0, neutral: 0, symbols: new Set() };
  
  // First, clear old news
  log('üóëÔ∏è X√≥a tin t·ª©c c≈© tr∆∞·ªõc khi sync...', 'warn');
  await fetch(`${SUPABASE_URL}/rest/v1/stock_news?id=gt.0`, { method: 'DELETE', headers });
  
  // Generate all news
  const allNews = [];
  
  // Add market news
  const marketNews = generateMarketNews();
  allNews.push(...marketNews);
  log(`üì∞ ƒê√£ t·∫°o ${marketNews.length} tin th·ªã tr∆∞·ªùng`, 'info');
  
  // Add stock news for each symbol
  for (const symbol of symbols) {
    const stockNews = generateNewsForSymbol(symbol);
    allNews.push(...stockNews);
    stats.symbols.add(symbol);
  }
  
  log(`üìä T·ªïng c·ªông ${allNews.length} tin t·ª©c c·∫ßn sync`, 'info');
  
  // Count sentiments
  allNews.forEach(n => {
    stats.total++;
    if (n.sentiment === 'positive') stats.positive++;
    else if (n.sentiment === 'negative') stats.negative++;
    else stats.neutral++;
  });
  
  // Batch insert (50 records per batch)
  const batchSize = 50;
  let successCount = 0;
  
  for (let i = 0; i < allNews.length; i += batchSize) {
    const batch = allNews.slice(i, i + batchSize);
    const progress = Math.round((i / allNews.length) * 100);
    setProgress(progress);
    
    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/stock_news`, {
        method: 'POST',
        headers: { ...headers, "Prefer": "return=minimal" },
        body: JSON.stringify(batch)
      });
      
      if (res.ok) {
        successCount += batch.length;
        log(`‚úÖ Batch ${Math.floor(i/batchSize) + 1}: ${batch.length} tin`, 'success');
      } else {
        const errText = await res.text();
        log(`‚ùå Batch error: ${res.status} - ${errText.substring(0, 100)}`, 'error');
      }
    } catch (err) {
      log(`‚ùå Exception: ${err.message}`, 'error');
    }
    
    // Small delay between batches
    await new Promise(r => setTimeout(r, 100));
  }
  
  setProgress(100);
  updateStats();
  log(`üéâ HO√ÄN TH√ÄNH! ƒê√£ sync ${successCount}/${allNews.length} tin t·ª©c cho ${stats.symbols.size} m√£`, 'success');
}

async function checkNews() {
  log('üîç Ki·ªÉm tra tin t·ª©c trong database...', 'info');
  
  try {
    // Get total count
    const countRes = await fetch(`${SUPABASE_URL}/rest/v1/stock_news?select=symbol,sentiment`, { headers });
    const countData = await countRes.json();
    
    stats = { total: countData.length, positive: 0, negative: 0, neutral: 0, symbols: new Set() };
    countData.forEach(n => {
      if (n.symbol) stats.symbols.add(n.symbol);
      if (n.sentiment === 'positive') stats.positive++;
      else if (n.sentiment === 'negative') stats.negative++;
      else stats.neutral++;
    });
    updateStats();
    
    log(`‚úÖ T·ªïng: ${stats.total} tin | ${stats.symbols.size} m√£ c√≥ tin t·ª©c`, 'success');
    
    // Check symbols without news
    const allSymbols = [...VN30, ...VN100_EXTRA];
    const missingSymbols = allSymbols.filter(s => !stats.symbols.has(s));
    if (missingSymbols.length > 0) {
      log(`‚ö†Ô∏è ${missingSymbols.length} m√£ ch∆∞a c√≥ tin: ${missingSymbols.slice(0, 10).join(', ')}...`, 'warn');
    }
    
    // Show sample news
    const sampleRes = await fetch(`${SUPABASE_URL}/rest/v1/stock_news?select=symbol,title,sentiment&order=published_at.desc&limit=5`, { headers });
    const sampleData = await sampleRes.json();
    log('üì∞ 5 tin m·ªõi nh·∫•t:', 'info');
    sampleData.forEach(n => {
      log(`  [${n.symbol || 'MARKET'}] ${n.title.substring(0, 50)}... (${n.sentiment})`, 'info');
    });
    
  } catch (err) {
    log(`‚ùå Error: ${err.message}`, 'error');
  }
}

log('‚úÖ Ready! Click "Sync Tin T·ª©c VN30/VN100" ƒë·ªÉ b·∫Øt ƒë·∫ßu.', 'success');
</script>
</body>
</html>
